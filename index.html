<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ENTERPRISE RESOURCE PLANNING | BETA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <style>
        :root { 
            --border: #d1d5db;
            --bg-main: #ffffff;
            --bg-soft: #f3f4f6;
            --bg-hover: #e5e7eb;
            --primary: #4b5563;
            --primary-light: #f9fafb;
            --text: #1f2937;
            --text-secondary: #6b7280;
            --danger: #ef4444;
            --success: #10b981;
            --overlay-bg: rgba(0,0,0,0.5);
            --warning: #f59e0b;
            --archive: #9ca3af;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --bg-main: #111827;
            --bg-soft: #1f2937;
            --bg-hover: #374151;
            --text: #f3f4f6;
            --text-secondary: #9ca3af;
            --border: #374151;
            --primary-light: #1f2937;
            --primary: #6b7280;
        }
        
        body.dark-mode .stat-label,
        body.dark-mode .card-actions .btn-action {
            color: #b0b0b0;
        }
        
        body.dark-mode .management-card {
            background: #1a1a1a;
            border-color: #2a2a2a;
        }
        
        body.dark-mode .management-card.selected {
            background: #1a2332;
            border-color: #4a9eff;
        }
        
        body.dark-mode .stat-card {
            background: #1a1a1a;
            border-color: #2a2a2a;
        }
        
        body.dark-mode .search-filter-bar input,
        body.dark-mode .search-filter-bar select {
            background: #1a1a1a;
            border-color: #2a2a2a;
            color: #e0e0e0;
        }
        
        body.dark-mode .search-filter-bar input:focus {
            border-color: #4a9eff;
            box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2);
        }
        
        body.dark-mode .bulk-actions-bar {
            background: #1a2332;
            border-color: #4a9eff;
        }
        
        body.dark-mode .management-actions .btn-action-main.btn-backup,
        body.dark-mode .management-actions .btn-action-main.btn-restore {
            background: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #2a2a2a;
        }
        
        body.dark-mode .card-actions .btn-action {
            background: #1a1a1a;
            border-color: #2a2a2a;
            color: #b0b0b0;
        }
        
        body.dark-mode .card-actions .btn-action.primary {
            background: transparent;
            color: #4a9eff;
            border-color: #4a9eff;
        }
        
        body.dark-mode .card-actions .btn-action.primary:hover {
            background: #1a2332;
        }
        
        body.dark-mode .card-actions .btn-action.warning {
            color: #f29900;
            border-color: #f29900;
        }
        
        body.dark-mode .card-actions .btn-action.danger {
            color: #d93025;
            border-color: #d93025;
        }
        
        body.dark-mode .card-actions .btn-action:hover {
            background: #252525;
        }
        
        body.dark-mode .card-actions .btn-action.warning:hover {
            background: #3a2f1a;
        }
        
        body.dark-mode .card-actions .btn-action.danger:hover {
            background: #3a1a1a;
        }
        
        body.dark-mode .category-title {
            border-bottom-color: #2a2a2a;
        }
        
        body.dark-mode .category-count {
            background: #1a2332;
            color: #4a9eff;
        }
        
        body.dark-mode .checkbox-card {
            border-color: #3a3a3a;
            background: #1a1a1a;
        }
        
        body.dark-mode .checkbox-card.checked {
            background: #4a9eff;
            border-color: #4a9eff;
        }
        
        body.dark-mode .badge-archive {
            background: #3a3a3a;
            color: #b0b0b0;
        }
        
        body.dark-mode #table-head th {
            background: #1a1a1a;
            border-color: #2a2a2a;
        }
        
        body.dark-mode td {
            border-color: #2a2a2a;
        }
        
        body.dark-mode .row-num {
            background: #1a1a1a;
        }
        
        body.dark-mode .flatpickr-calendar {
            background: #1a1a1a !important;
            border-color: #2a2a2a !important;
        }
        
        body.dark-mode .flatpickr-day {
            color: #e0e0e0 !important;
        }
        
        body.dark-mode .flatpickr-day:hover {
            background: #2a2a2a !important;
        }
        
        body.dark-mode .flatpickr-day.selected {
            background: #4a9eff !important;
            border-color: #4a9eff !important;
        }
        
        body.dark-mode .sheet {
            background: #1a1a1a;
            border-color: #2a2a2a;
        }
        
        body.dark-mode .btn-ui {
            background: #1a1a1a;
            border-color: #2a2a2a;
            color: #e0e0e0;
        }
        
        body.dark-mode .btn-ui:hover {
            background: #252525;
        }
        
        body.dark-mode .cat-header:hover {
            background: #252525;
        }
        
        body.dark-mode .tab-btn:hover {
            background: rgba(255,255,255,0.05);
        }
        
        body.dark-mode .preview-table th {
            background: #4a9eff;
            color: #121212;
        }
        
        body.dark-mode .preview-table td {
            border-color: #2a2a2a;
        }

        /* LOGIN PAGE STYLES */
        .login-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 16px;
        }

        .login-page.hidden {
            display: none;
        }

        .login-box {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 420px;
            padding: 32px 24px;
            animation: fadeInUp 0.4s ease;
        }

        @media (max-width: 640px) {
            .login-box {
                padding: 24px 20px;
                max-width: 100%;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-logo-section {
            text-align: center;
            margin-bottom: 28px;
        }

        .login-logo-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #6b7280, #4b5563);
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            box-shadow: var(--shadow-md);
        }

        @media (max-width: 640px) {
            .login-logo-icon {
                width: 48px;
                height: 48px;
            }
        }

        .login-logo-icon svg {
            width: 32px;
            height: 32px;
            fill: white;
        }

        @media (max-width: 640px) {
            .login-logo-icon svg {
                width: 28px;
                height: 28px;
            }
        }

        .login-app-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }

        @media (max-width: 640px) {
            .login-app-title {
                font-size: 20px;
            }
        }

        .login-app-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        @media (max-width: 640px) {
            .login-app-subtitle {
                font-size: 12px;
            }
        }

        .login-error {
            background: #fee;
            color: var(--danger);
            padding: 12px 14px;
            border-radius: 8px;
            margin-bottom: 18px;
            font-size: 13px;
            display: none;
            border-left: 3px solid var(--danger);
            animation: shake 0.3s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .login-error.show {
            display: block;
        }

        .login-suggested {
            margin-bottom: 22px;
            display: none;
        }

        .login-suggested.show {
            display: block;
        }

        .login-suggested-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .login-account-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .login-account-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-main);
        }

        .login-account-item:hover {
            border-color: var(--primary);
            background: var(--bg-soft);
            transform: translateX(2px);
        }

        .login-account-item:active {
            transform: translateX(0) scale(0.98);
        }

        .login-account-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6b7280, #4b5563);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 15px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        @media (max-width: 640px) {
            .login-account-avatar {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }
        }

        .login-account-info {
            flex: 1;
            min-width: 0;
        }

        .login-account-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 640px) {
            .login-account-name {
                font-size: 13px;
            }
        }

        .login-account-username {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 640px) {
            .login-account-username {
                font-size: 11px;
            }
        }

        .login-account-remove {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
            opacity: 0;
            flex-shrink: 0;
        }

        .login-account-item:hover .login-account-remove {
            opacity: 1;
        }

        .login-account-remove:hover {
            background: #fee;
            color: var(--danger);
        }

        .login-divider {
            text-align: center;
            margin: 18px 0;
            position: relative;
        }

        .login-divider::before,
        .login-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 42%;
            height: 1px;
            background: var(--border);
        }

        .login-divider::before {
            left: 0;
        }

        .login-divider::after {
            right: 0;
        }

        .login-divider span {
            background: white;
            padding: 0 10px;
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (max-width: 640px) {
            .login-divider span {
                font-size: 10px;
            }
        }

        .login-form-group {
            margin-bottom: 16px;
        }

        .login-form-label {
            display: block;
            font-size: 13px;
            color: var(--text);
            margin-bottom: 6px;
            font-weight: 600;
        }

        @media (max-width: 640px) {
            .login-form-label {
                font-size: 12px;
            }
        }

        .login-form-input {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text);
            transition: all 0.2s ease;
            background: var(--bg-main);
        }

        @media (max-width: 640px) {
            .login-form-input {
                padding: 11px 13px;
                font-size: 13px;
            }
        }

        .login-form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(75, 85, 99, 0.1);
        }

        .login-form-input::placeholder {
            color: var(--text-secondary);
        }

        .login-password-wrapper {
            position: relative;
        }

        .login-toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-soft);
            border: none;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 10px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .login-toggle-password:hover {
            background: var(--bg-hover);
            color: var(--text);
        }

        .login-toggle-password:active {
            transform: translateY(-50%) scale(0.95);
        }

        .login-checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .login-checkbox {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .login-checkbox-label {
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }

        @media (max-width: 640px) {
            .login-checkbox-label {
                font-size: 12px;
            }
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            position: relative;
        }

        @media (max-width: 640px) {
            .login-btn {
                padding: 11px;
                font-size: 13px;
            }
        }

        .login-btn:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn:disabled {
            background: var(--bg-hover);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .login-btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid white;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .login-footer {
            text-align: center;
            margin-top: 24px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        @media (max-width: 640px) {
            .login-footer {
                font-size: 10px;
                margin-top: 20px;
            }
        }

        .login-reset-btn {
            background: transparent;
            border: 1.5px solid var(--border);
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 12px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .login-reset-btn:hover {
            border-color: var(--primary);
            color: var(--text);
            background: var(--bg-soft);
        }

        @media (max-width: 640px) {
            .login-reset-btn {
                font-size: 10px;
                padding: 7px 12px;
            }
        }

        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

        body{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            line-height:1.6;
            background:var(--bg-main);
            color:var(--text);
            overflow:auto;
            display:flex;
            flex-direction:column;
            min-height:100vh;
            transition:background .3s, color .3s;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            body {
                font-size: 13px;
            }
        }

        .flatpickr-calendar { border-radius: 15px !important; box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important; border: none !important; }
        .flatpickr-day.selected { background: var(--primary) !important; border-color: var(--primary) !important; }
        .flatpickr-clear-button { width: 100%; background: var(--danger); color: white; border: none; padding: 12px; font-weight: bold; cursor: pointer; }

        /* PROFILE STYLES */
        .profile-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-main);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 5000;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .profile-modal.active {
            display: block;
        }
        .profile-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .profile-header h2 {
            font-size: 18px;
            font-weight: bold;
        }
        .profile-content {
            padding: 20px;
        }
        .profile-field {
            margin-bottom: 20px;
        }
        .profile-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 13px;
            color: #666;
        }
        .profile-field input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-main);
            color: var(--text);
        }
        .profile-field input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        .profile-actions {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn-profile {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-profile.primary {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        .btn-profile.primary:hover {
            background: var(--primary-light);
            color: var(--primary);
        }
        .btn-profile.secondary {
            background: var(--bg-soft);
            border: 1px solid var(--border);
            color: var(--text);
        }
        .btn-profile.secondary:hover {
            background: var(--bg-soft);
            border-color: var(--primary);
        }
        
        /* USER MANAGEMENT STYLES */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .user-table th,
        .user-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .user-table th {
            background: var(--bg-soft);
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
        }
        .user-table input,
        .user-table select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 13px;
            background: var(--bg-main);
            color: var(--text);
        }
        .user-table input:focus,
        .user-table select:focus {
            outline: none;
            border-color: var(--primary);
        }
        .btn-user {
            padding: 6px 12px;
            border-radius: 5px;
            border: 1.5px solid;
            background: transparent;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        .btn-user.edit {
            border-color: var(--primary);
            color: var(--primary);
        }
        .btn-user.edit:hover {
            background: var(--primary-light);
        }
        .btn-user.delete {
            border-color: var(--danger);
            color: var(--danger);
        }
        .btn-user.delete:hover {
            background: #ffebee;
        }
        .btn-user.add {
            border-color: var(--success);
            color: var(--success);
            width: 100%;
        }
        .btn-user.add:hover {
            background: #e8f5e9;
        }
        .user-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .user-badge.admin {
            background: var(--primary-light);
            color: var(--primary);
        }
        .user-badge.user {
            background: #f0f0f0;
            color: #666;
        }

        /* LAYAR LOGIN */
        #login-screen { 
            position: fixed; 
            inset: 0; 
            background: #ffffff;
            z-index: 9999; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        #login-screen.hidden {
            display: none !important;
        }
        .login-card { 
            background: #ffffff; 
            padding: 40px 30px; 
            width: 90%; 
            max-width: 380px; 
            text-align: center;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .login-card h2 {
            font-size: 20px;
            color: #1a73e8;
            font-weight: 800;
            margin-bottom: 10px;
            letter-spacing: 1px;
            line-height: 1.3;
        }
        .login-card p {
            font-size: 14px;
            color: #666;
            margin-bottom: 35px;
        }
        .login-card input {
            width: 100%;
            padding: 16px 20px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }
        .login-card input:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }
        .login-buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }
        .login-card button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-login {
            background: transparent;
            color: #1a73e8;
            border: 2px solid #1a73e8;
        }
        .btn-login:hover {
            background: #e8f0fe;
            border-color: #1557b0;
            color: #1557b0;
            transform: translateY(-2px);
        }
        .btn-view {
            background: transparent;
            color: #666;
            border: 2px solid #e0e0e0;
        }
        .btn-view:hover {
            background: #f9f9f9;
            border-color: #ccc;
            transform: translateY(-2px);
        }

        /* HEADER & SIDEBAR */
        header {
            padding: 0 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            background: var(--bg-main);
            height: 56px;
            justify-content: space-between;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
        }
        
        @media (max-width: 768px) {
            header {
                height: 52px;
                padding: 0 12px;
            }
        }
        
        #sidebar { 
            width: 280px;
            background: var(--bg-main);
            position: fixed;
            left: -280px;
            top: 0;
            height: 100%;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1100;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            border-right: 1px solid var(--border);
        }
        
        @media (max-width: 768px) {
            #sidebar {
                width: 260px;
                left: -260px;
            }
        }
        
        #sidebar.active { left: 0; }
        
        .sidebar-header {
            padding: 24px 20px 12px;
            font-weight: 700;
            font-size: 12px;
            color: var(--text);
            letter-spacing: 0.5px;
            line-height: 1.5;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
        }
        
        @media (max-width: 768px) {
            .sidebar-header {
                padding: 20px 16px 10px;
                font-size: 11px;
            }
        }
        
        .cat-group { }
        
        .cat-header {
            width: 100%;
            padding: 14px 20px;
            background: var(--bg-main);
            border: none;
            text-align: left;
            font-weight: 700;
            font-size: 11px;
            color: var(--text);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-transform: uppercase;
            transition: all 0.2s ease;
            letter-spacing: 0.5px;
        }
        
        @media (max-width: 768px) {
            .cat-header {
                padding: 12px 16px;
                font-size: 10px;
            }
        }
        
        .cat-header:hover {
            background: var(--bg-soft);
        }
        
        .cat-content {
            display: none;
            background: var(--bg-soft);
        }
        
        .cat-content.active {
            display: block;
        }
        
        .tab-btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            background: transparent;
            text-align: left;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            transition: all 0.2s ease;
        }
        
        @media (max-width: 768px) {
            .tab-btn {
                padding: 11px 16px;
                font-size: 12px;
            }
        }
        
        .tab-btn:hover {
            background: rgba(0,0,0,0.04);
        }
        
        .tab-btn.active {
            color: var(--primary);
            background: var(--primary-light);
            font-weight: 700;
        }
        
        .tab-btn.archived {
            opacity: 0.5;
            font-style: italic;
        }

        /* UI COMPONENTS */
        .btn-ui {
            padding: 8px 14px;
            border: 1px solid var(--border);
            background: var(--bg-main);
            color: var(--text);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .btn-ui {
                padding: 7px 12px;
                font-size: 12px;
            }
        }
        
        .btn-ui:hover {
            background: var(--bg-soft);
            border-color: var(--primary);
        }
        
        .toolbar {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--bg-soft);
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        
        @media (max-width: 768px) {
            .toolbar {
                padding: 10px 12px;
                gap: 8px;
            }
        }
        
        .date-input-container {
            display: flex;
            align-items: center;
            background: var(--bg-main);
            border: 1.5px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .date-input-container:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(75, 85, 99, 0.1);
        }
        
        #dateRangePicker {
            flex-grow: 1;
            border: none;
            padding: 11px 14px;
            font-size: 13px;
            background: transparent;
            color: var(--text);
            font-weight: 600;
            outline: none;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            #dateRangePicker {
                padding: 10px 12px;
                font-size: 12px;
            }
        }

        /* TABLE */
        .table-container {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: auto;
            background: var(--bg-main);
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 160px);
        }
        
        @media (max-width: 768px) {
            .table-container {
                max-height: calc(100vh - 140px);
            }
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed;
            font-size: 13px;
        }
        
        @media (max-width: 768px) {
            table {
                font-size: 12px;
            }
        }
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        thead tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        tbody {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        tbody tr {
            display: table-row;
        }
        th {
            background: var(--bg-soft);
            padding: 0;
            border: 1px solid var(--border);
            font-size: 11px;
            color: var(--text);
            width: 130px;
            font-weight: 700;
        }
        
        @media (max-width: 768px) {
            th {
                font-size: 10px;
                width: 110px;
            }
        }
        
        .th-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            cursor: pointer;
            min-height: 44px;
        }
        
        @media (max-width: 768px) {
            .th-inner {
                padding: 8px;
                min-height: 40px;
            }
        }
        
        td {
            border: 1px solid var(--border);
            padding: 0;
            height: 48px;
            width: 130px;
        }
        
        @media (max-width: 768px) {
            td {
                height: 44px;
                width: 110px;
            }
        }
        
        td input {
            border: none;
            padding: 0 10px;
            font-size: 13px;
            outline: none;
            background: transparent;
            width: 100%;
            height: 100%;
            color: var(--text);
        }
        
        @media (max-width: 768px) {
            td input {
                padding: 0 8px;
                font-size: 12px;
            }
        }
        
        .row-num {
            width: 65px !important;
            background: var(--bg-soft);
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            color: var(--primary);
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .row-num {
                width: 50px !important;
                font-size: 11px;
            }
        }

        /* NOTIF & OVERLAY */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--text);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 10000;
            transition: 0.3s ease;
            box-shadow: var(--shadow-lg);
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            #toast {
                font-size: 12px;
                padding: 10px 18px;
                max-width: 90%;
            }
        }
        
        #toast.active {
            transform: translateX(-50%) translateY(0);
        }
        
        #overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--overlay-bg);
            z-index: 1050;
            backdrop-filter: blur(3px);
        }
        
        #overlay.active {
            display: block;
        }

        /* NAVIGATION & SHEETS */
        .nav-box{
            display:flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px 12px; 
            background:var(--bg-main); 
            border-top: 2px solid var(--primary); 
            flex-shrink: 0;
            position: relative;
        }
        .sheet{
            position:fixed;
            top:50%;
            left:50%;
            transform:translate(-50%, -50%) scale(0.7);
            opacity:0;
            background:var(--bg-main);
            z-index:5000;
            border-radius:16px;
            padding:25px 20px;
            transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
            max-width:600px;
            width:90%;
            box-shadow:0 10px 40px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            max-height: 85vh;
            overflow-y: auto;
            pointer-events:none;
        }
        .sheet.active{
            transform:translate(-50%, -50%) scale(1);
            opacity:1;
            pointer-events:auto;
        }
        .sheet-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;}
        .close-btn{background:var(--bg-soft); border:none; padding:8px 15px; border-radius:8px; font-weight:bold; cursor:pointer; color:var(--danger);}
        .cat-item-select { padding: 15px; border: 1px solid var(--border); margin-bottom: 8px; border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .cat-item-select:hover { background: var(--primary-light); }

        /* MANAGEMENT SPECIFIC - IMPROVED */
        .management-card {
            background: var(--bg-soft);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 6px;
            transition: all 0.2s;
        }
        .management-card.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        .management-card.archived {
            opacity: 0.6;
            border-style: dashed;
        }
        .checkbox-card {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-radius: 3px;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .checkbox-card:hover {
            border-color: var(--primary);
            transform: scale(1.1);
        }
        .checkbox-card.checked {
            background: var(--primary);
            border-color: var(--primary);
            position: relative;
        }
        .checkbox-card.checked::after {
            content: 'âœ“';
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: bold;
        }
        
        /* IMPROVED CARD ACTIONS */
        .card-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            margin-top: 6px;
        }
        
        .card-actions .btn-action {
            padding: 6px 4px;
            font-size: 9px;
            font-weight: 700;
            border: 1px solid var(--border);
            background: var(--bg-main);
            color: var(--text);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            white-space: nowrap;
        }
        
        .card-actions .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .card-actions .btn-action.primary {
            background: transparent;
            color: var(--primary);
            border-color: var(--primary);
        }
        
        .card-actions .btn-action.primary:hover {
            background: var(--primary-light);
        }
        
        .card-actions .btn-action.warning {
            color: var(--warning);
            border-color: var(--warning);
        }
        
        .card-actions .btn-action.warning:hover {
            background: #fff3e0;
        }
        
        .card-actions .btn-action.danger {
            color: var(--danger);
            border-color: var(--danger);
        }
        
        .card-actions .btn-action.danger:hover {
            background: #ffebee;
        }
        
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        .stat-card {
            background: var(--bg-soft);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        .stat-card:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
        }
        .stat-value {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 2px;
            line-height: 1;
        }
        .stat-label {
            font-size: 9px;
            color: #888;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.2px;
            line-height: 1.2;
        }
        
        .search-filter-bar {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            align-items: stretch;
        }
        
        .search-filter-bar input {
            flex-grow: 1;
            border: 1px solid var(--border);
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 12px;
            outline: none;
            transition: all 0.2s;
        }
        
        .search-filter-bar input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }
        
        .search-filter-bar select {
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 11px;
            color: var(--text);
            background: var(--bg-main);
            padding: 8px 10px;
            cursor: pointer;
            outline: none;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .search-filter-bar select:hover {
            border-color: var(--primary);
        }
        
        .bulk-actions-bar {
            display: none;
            background: var(--primary-light);
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            gap: 6px;
            align-items: center;
            border: 1px solid var(--primary);
        }
        .bulk-actions-bar.active {
            display: flex;
        }
        
        .bulk-actions-bar .btn-ui {
            padding: 6px 10px;
            font-size: 10px;
            font-weight: 700;
            border-radius: 5px;
        }
        
        /* ACTION BUTTONS SECTION */
        .management-actions {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .management-actions .btn-action-main {
            flex: 1;
            min-width: 80px;
            padding: 7px 10px;
            font-size: 10px;
            font-weight: 700;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            letter-spacing: 0.2px;
            white-space: nowrap;
        }
        
        .management-actions .btn-action-main:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .management-actions .btn-create {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .management-actions .btn-create:hover {
            background: var(--primary-light);
        }
        
        .management-actions .btn-export {
            background: transparent;
            color: var(--success);
            border: 2px solid var(--success);
        }
        
        .management-actions .btn-export:hover {
            background: #e8f5e9;
        }
        
        .management-actions .btn-backup {
            background: var(--bg-soft);
            color: var(--text);
            border: 2px solid var(--border);
        }
        
        .management-actions .btn-restore {
            background: var(--bg-soft);
            color: var(--text);
            border: 2px solid var(--border);
        }

        /* CUSTOM GRID ICON */
        .grid-icon {
            display: inline-grid;
            grid-template-columns: repeat(3, 4px);
            grid-template-rows: repeat(3, 4px);
            gap: 2px;
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }
        .grid-icon span {
            background: currentColor;
            border-radius: 1px;
        }

        /* CUSTOM POWER ICON */
        .power-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            position: relative;
        }
        .power-icon::before {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            border: 2.5px solid currentColor;
            border-radius: 50%;
            border-top: 2.5px solid transparent;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .power-icon::after {
            content: '';
            position: absolute;
            width: 2.5px;
            height: 10px;
            background: currentColor;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 2px;
        }

        /* PREVIEW TABLE */
        .preview-table {
            max-height: 300px;
            overflow: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 10px;
        }
        .preview-table table {
            font-size: 11px;
        }
        .preview-table th {
            background: var(--primary);
            color: white;
            padding: 8px;
            font-weight: 600;
        }
        .preview-table td {
            padding: 6px 8px;
            border: 1px solid var(--border);
        }
        
        /* CATEGORY HEADER */
        .category-section {
            margin-bottom: 15px;
        }
        
        .category-title {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
        }
        
        .category-title h3 {
            font-size: 12px;
            font-weight: 800;
            color: var(--text);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .category-count {
            background: var(--primary-light);
            color: var(--primary);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 800;
        }

        /* UTILITY */
        input[readonly] { cursor: default; background-color: transparent !important; border: none !important; outline: none !important; }
        .readonly-cell { cursor: default !important; pointer-events: none; }
        .admin-hidden { display: none !important; }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 700;
            margin-left: 6px;
            letter-spacing: 0.3px;
        }
        .badge-archive {
            background: var(--archive);
            color: white;
        }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <div class="login-logo-section">
            <div class="login-logo-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                </svg>
            </div>
            <h1 class="login-app-title">ERP SYSTEM</h1>
            <p class="login-app-subtitle">Enterprise Resource Planning</p>
        </div>

        <div id="login-error" class="login-error"></div>

        <!-- Suggested Accounts -->
        <div id="login-suggested" class="login-suggested">
            <div class="login-suggested-title">Pilih Akun</div>
            <div id="login-account-list" class="login-account-list"></div>
            <div class="login-divider">
                <span>atau login dengan akun lain</span>
            </div>
        </div>

        <form id="login-form" onsubmit="handleLoginSubmit(event)">
            <div class="login-form-group">
                <label class="login-form-label" for="login-username">Username</label>
                <input 
                    type="text" 
                    id="login-username" 
                    class="login-form-input" 
                    placeholder="Masukkan Username"
                    required
                    autocomplete="username"
                >
            </div>

            <div class="login-form-group">
                <label class="login-form-label" for="login-password">Password</label>
                <div class="login-password-wrapper">
                    <input 
                        type="password" 
                        id="login-password" 
                        class="login-form-input" 
                        placeholder="Masukkan Password"
                        required
                        autocomplete="current-password"
                        style="padding-right: 70px;"
                    >
                    <button type="button" class="login-toggle-password" onclick="toggleLoginPassword()">
                        SHOW
                    </button>
                </div>
            </div>

            <div class="login-checkbox-group">
                <input 
                    type="checkbox" 
                    id="login-remember" 
                    class="login-checkbox"
                >
                <label for="login-remember" class="login-checkbox-label">Remember Me</label>
            </div>

            <button type="submit" class="login-btn" id="login-submit-btn">
                Login
            </button>
        </form>

        <div style="text-align: center;">
            <button onclick="createDefaultUsersFromLogin()" class="login-reset-btn">
                Reset User Default
            </button>
        </div>

        <div class="login-footer">
            Â© 2024 ERP System. All Rights Reserved
        </div>
    </div>
</div>

<div id="overlay" onclick="closeAll()"></div>
<div id="toast">Notifikasi</div>

<div id="sidebar">
    <div class="sidebar-header" id="sidebarHeader">RIFAKHI RINDHOI SETIAWAN</div>
    <div style="flex-grow: 1; overflow-y: auto;" id="sidebar-content"></div>
</div>

<header>
    <div style="display:flex;align-items:center;gap:12px;">
        <button onclick="toggleSidebar()" style="background:transparent;border:none;padding:8px 12px;border-radius:6px;font-weight:bold;font-size:20px;color:var(--text);cursor:pointer;">â˜°</button>
        <div id="disp-title" style="font-weight:600;font-size:15px;color:var(--primary);text-transform:uppercase;">Dashboard</div>
    </div>
    <button onclick="logout()" style="background:transparent;border:none;padding:8px 12px;font-size:20px;color:var(--danger);cursor:pointer;" title="Logout"><span class="power-icon"></span></button>
</header>

<div class="toolbar">
    <div class="date-input-container">
        <input type="text" id="dateRangePicker" placeholder="Tap untuk pilih rentang tanggal..." readonly>
    </div>
    <div style="display:flex; gap:8px; width:100%; align-items:center;">
        <button onclick="exportToExcel()" class="btn-ui" style="font-size:11px;">EXPORT</button>
        <button onclick="document.getElementById('importFile').click()" class="btn-ui admin-only" style="font-size:11px;">IMPORT</button>
        <input type="file" id="importFile" hidden onchange="importFromExcel(event)">
        <input type="text" id="searchInp" placeholder="Cari..." oninput="doSearch()" style="flex-grow:1; border:1px solid var(--primary); padding:8px 12px; border-radius:20px; font-size:13px; outline:none;">
    </div>
</div>

<div class="table-container">
    <table id="mainTable">
        <thead><tr id="table-head"></tr></thead>
        <tbody id="table-body"></tbody>
    </table>
    
    <div class="nav-box">
        <div style="display: flex; align-items: center; gap: 5px;">
            <select id="rowsPerPageSelect" onchange="updateRowsPerPage(this.value)" style="border: 1px solid var(--border); border-radius: 3px; font-size: 10px; color: var(--text); background: var(--bg-main); padding: 4px 6px; cursor: pointer; outline: none; min-width: 45px;">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
            
            <button class="btn-ui" onclick="changePage(1)" style="padding: 4px 8px; font-size: 13px; min-width: 30px;" title="First Page">â®</button>
            <button class="btn-ui" onclick="changePage(currentPage-1)" style="padding: 4px 8px; font-size: 13px; min-width: 30px;" title="Previous">â—€</button>
            
            <div style="display: flex; align-items: center; gap: 5px;">
                <span style="font-size: 11px; color: var(--text);">Page</span>
                <input type="number" id="pageInput" value="1" min="1" onchange="goToPage(this.value)" style="width: 40px; padding: 4px; border: 1px solid var(--border); border-radius: 3px; text-align: center; font-size: 11px; font-weight: 700; color: var(--primary);">
                <span style="font-size: 11px; color: var(--text);">of <span id="totalPages">1</span></span>
            </div>
            
            <button class="btn-ui" onclick="changePage(currentPage+1)" style="padding: 4px 8px; font-size: 13px; min-width: 30px;" title="Next">â–¶</button>
            <button class="btn-ui" onclick="changePage(parseInt(document.getElementById('totalPages').textContent))" style="padding: 4px 8px; font-size: 13px; min-width: 30px;" title="Last Page">â­</button>
            
            <button class="btn-ui" onclick="render()" style="padding: 4px 8px; font-size: 13px; min-width: 30px;" title="Refresh">â†»</button>
        </div>
        
        <div id="page-info" style="font-size: 10px; color: var(--text); font-weight: 600;">Displaying 1 to 10 of 0 items</div>
    </div>
</div>
    </table>
</div>

<div id="sheet-menu" class="sheet">
    <div class="sheet-header"><strong>OPSI BARIS</strong><button class="close-btn" onclick="closeModal()">TUTUP</button></div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button class="btn-ui" style="padding:18px;" onclick="handleExecAction('add_row')">TAMBAH BARIS</button>
        <button class="btn-ui" style="padding:18px;" onclick="handleExecAction('add_col')">TAMBAH KOLOM</button>
        <button class="btn-ui" style="padding:18px; color: var(--danger);" onclick="handleExecAction('del_row')">HAPUS BARIS INI</button>
        <button class="btn-ui" style="padding:18px; color: var(--danger); border: 2px solid var(--danger);" onclick="handleExecAction('clear_all')">HAPUS SEMUA</button>
    </div>
</div>

<div id="sheet-filter" class="sheet">
    <div class="sheet-header"><strong>SORTING & KOLOM</strong><button class="close-btn" onclick="closeModal()">TUTUP</button></div>
    <div style="display: flex; flex-direction: column; gap: 8px;">
        <button class="btn-ui" style="padding:16px; text-align:left;" onclick="handleSortData('asc')">URUTKAN A - Z</button>
        <button class="btn-ui" style="padding:16px; text-align:left;" onclick="handleSortData('desc')">URUTKAN Z - A</button>
        <button class="btn-ui" style="padding:16px; text-align:left; color: var(--primary);" onclick="handleExecAction('edit_header')">GANTI NAMA KOLOM</button>
        <button class="btn-ui" style="padding:16px; text-align:left; color: var(--success);" onclick="fillColCurrentDate()">ISI TANGGAL HARI INI</button>
        <button class="btn-ui" style="padding:16px; text-align:left; color: var(--danger);" onclick="handleExecAction('del_col')">HAPUS KOLOM INI</button>
    </div>
</div>

<div id="sheet-table-manager" class="sheet">
    <div class="sheet-header"><strong>PENGELOLA TABEL</strong><button class="close-btn" onclick="closeModal()">TUTUP</button></div>
    <div id="manager-content"></div>
    <div style="display: flex; flex-direction: column; gap: 12px;">
        <button class="btn-ui" style="padding:15px; color:var(--primary);" onclick="createNewTable()">BUAT TABEL BARU</button>
        <button class="btn-ui" style="padding:15px;" onclick="renameTable()">UBAH NAMA TABEL</button>
        <button class="btn-ui" style="padding:15px; background:var(--primary-light);" onclick="openCatPicker()">PINDAH KATEGORI</button>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn-ui" onclick="moveTable('up')">PINDAH KE ATAS</button>
            <button class="btn-ui" onclick="moveTable('down')">PINDAH KE BAWAH</button>
        </div>
        <button class="btn-ui" style="padding:15px; color:var(--danger);" onclick="deleteCategory()">HAPUS KATEGORI</button>
        <button class="btn-ui" style="padding:15px; color:var(--danger); border: 1px solid var(--danger);" onclick="deleteCurrentTable()">HAPUS TABEL AKTIF</button>
    </div>
</div>

<div id="sheet-cat-picker" class="sheet" style="z-index: 6000;">
    <div class="sheet-header"><strong>PILIH KATEGORI</strong><button class="close-btn" onclick="closeCatPicker()">KEMBALI</button></div>
    <div id="cat-list-box" style="margin-bottom: 20px;"></div>
    <div style="border-top: 1px solid var(--border); padding-top: 15px;">
        <input type="text" id="newCatInp" placeholder="Nama Kategori Baru..." style="width:100%; padding:15px; border-radius:10px; border:1px solid var(--border);">
        <button class="btn-ui" style="width:100%; margin-top:10px; background:transparent; color:var(--primary); border: 2px solid var(--primary); padding:15px;" onclick="applyNewCat()">PINDAH KE KATEGORI INI</button>
    </div>
</div>

<div id="custom-prompt-modal" class="sheet" style="z-index: 7000;">
    <div class="sheet-header"><strong id="prompt-title">INPUT</strong><button class="close-btn" onclick="closeCustomPrompt()">BATAL</button></div>
    <div style="padding: 10px 0;">
        <input type="text" id="custom-prompt-input" placeholder="Masukkan nilai..." style="width:100%; padding:15px; border-radius:10px; border:2px solid var(--primary); font-size: 14px; outline: none;">
    </div>
    <button class="btn-ui" id="custom-prompt-ok" style="width:100%; background:transparent; color:var(--primary); border: 2px solid var(--primary); padding:15px; font-weight: 700;">OK</button>
</div>

<div id="custom-confirm-modal" class="sheet" style="z-index: 7000;">
    <div class="sheet-header"><strong id="confirm-title">KONFIRMASI</strong></div>
    <div style="padding: 20px 0;">
        <p id="confirm-message" style="font-size: 14px; text-align: center; color: var(--text); line-height: 1.6;"></p>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn-ui" id="custom-confirm-cancel" style="flex: 1; padding:15px; font-weight: 700;">BATAL</button>
        <button class="btn-ui" id="custom-confirm-ok" style="flex: 1; background:transparent; color:var(--danger); border: 2px solid var(--danger); padding:15px; font-weight: 700;">HAPUS</button>
    </div>
</div>

<!-- Preview Modal -->
<div id="sheet-preview" class="sheet" style="max-width: 800px;">
    <div class="sheet-header"><strong id="preview-title">PREVIEW DATA</strong><button class="close-btn" onclick="closePreview()">TUTUP</button></div>
    <div id="preview-content"></div>
</div>

<!-- Profile Modal -->
<div id="profile-modal" class="profile-modal">
    <div class="profile-header">
        <h2>PENGATURAN AKUN</h2>
        <button class="close-btn" onclick="closeProfile()" style="background:var(--bg-soft);border:none;padding:8px 15px;border-radius:8px;font-weight:bold;cursor:pointer;">âœ•</button>
    </div>
    <div class="profile-content">
        <!-- User Info Section -->
        <div style="background: linear-gradient(135deg, var(--primary) 0%, #0d5bbd 100%); border-radius: 12px; padding: 24px; margin-bottom: 20px; color: white;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div id="profile-avatar" style="width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 700; border: 3px solid rgba(255,255,255,0.5);">A</div>
                <div style="flex: 1;">
                    <div id="profile-display-name" style="font-size: 20px; font-weight: 700; margin-bottom: 4px;">Loading...</div>
                    <div id="profile-display-username" style="font-size: 13px; opacity: 0.9;">@username</div>
                </div>
            </div>
        </div>
        
        <!-- Statistics Cards -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
            <div style="background: var(--bg-soft); border-radius: 10px; padding: 16px; text-align: center; border: 1px solid var(--border);">
                <div id="profile-stat-tables" style="font-size: 28px; font-weight: 700; color: var(--primary); font-family: monospace;">0</div>
                <div style="font-size: 12px; color: #666; font-weight: 600; margin-top: 4px;">TOTAL TABLES</div>
            </div>
            <div style="background: var(--bg-soft); border-radius: 10px; padding: 16px; text-align: center; border: 1px solid var(--border);">
                <div id="profile-stat-records" style="font-size: 28px; font-weight: 700; color: var(--success); font-family: monospace;">0</div>
                <div style="font-size: 12px; color: #666; font-weight: 600; margin-top: 4px;">TOTAL RECORDS</div>
            </div>
        </div>
        
        <!-- Editable Fields -->
        <div class="profile-field">
            <label>Nama Lengkap</label>
            <input type="text" id="profile-name" placeholder="Masukkan nama lengkap...">
        </div>
        <div class="profile-field">
            <label>NIK / NIP</label>
            <input type="text" id="profile-nik" placeholder="Nomor Induk Karyawan...">
        </div>
        <div class="profile-field">
            <label>Tanggal Lahir</label>
            <input type="date" id="profile-birthdate" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg-main); color: var(--text);">
        </div>
        <div class="profile-field">
            <label>Tempat Lahir</label>
            <input type="text" id="profile-birthplace" placeholder="Kota kelahiran...">
        </div>
        <div class="profile-field">
            <label>Jenis Kelamin</label>
            <select id="profile-gender" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg-main); color: var(--text); cursor: pointer;">
                <option value="">Pilih jenis kelamin...</option>
                <option value="Laki-laki">Laki-laki</option>
                <option value="Perempuan">Perempuan</option>
            </select>
        </div>
        <div class="profile-field">
            <label>Email</label>
            <input type="email" id="profile-email" placeholder="email@example.com">
        </div>
        <div class="profile-field">
            <label>Nomor Telepon</label>
            <input type="tel" id="profile-phone" placeholder="+62 xxx xxxx xxxx">
        </div>
        <div class="profile-field">
            <label>Agama</label>
            <select id="profile-religion" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg-main); color: var(--text); cursor: pointer;">
                <option value="">Pilih agama...</option>
                <option value="Islam">Islam</option>
                <option value="Kristen">Kristen</option>
                <option value="Katolik">Katolik</option>
                <option value="Hindu">Hindu</option>
                <option value="Buddha">Buddha</option>
                <option value="Konghucu">Konghucu</option>
            </select>
        </div>
        <div class="profile-field">
            <label>Status Perkawinan</label>
            <select id="profile-marital" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg-main); color: var(--text); cursor: pointer;">
                <option value="">Pilih status...</option>
                <option value="Belum Menikah">Belum Menikah</option>
                <option value="Menikah">Menikah</option>
                <option value="Cerai">Cerai</option>
            </select>
        </div>
        <div class="profile-field">
            <label>Kewarganegaraan</label>
            <input type="text" id="profile-nationality" placeholder="Contoh: Indonesia" value="Indonesia">
        </div>
        <div class="profile-field">
            <label>Jabatan / Posisi</label>
            <input type="text" id="profile-position" placeholder="Posisi Anda...">
        </div>
        <div class="profile-field">
            <label>Departemen</label>
            <input type="text" id="profile-department" placeholder="Departemen...">
        </div>
        <div class="profile-field">
            <label>Divisi</label>
            <input type="text" id="profile-division" placeholder="Divisi...">
        </div>
        <div class="profile-field">
            <label>Tanggal Bergabung</label>
            <input type="date" id="profile-joindate" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg-main); color: var(--text);">
        </div>
        <div class="profile-field">
            <label>Pendidikan Terakhir</label>
            <select id="profile-education" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg-main); color: var(--text); cursor: pointer;">
                <option value="">Pilih pendidikan...</option>
                <option value="SD">SD</option>
                <option value="SMP">SMP</option>
                <option value="SMA/SMK">SMA/SMK</option>
                <option value="D3">D3</option>
                <option value="S1">S1</option>
                <option value="S2">S2</option>
                <option value="S3">S3</option>
            </select>
        </div>
        <div class="profile-field">
            <label>Alamat Lengkap</label>
            <textarea id="profile-address" placeholder="Jalan, RT/RW, Kelurahan, Kecamatan, Kota, Provinsi, Kode Pos" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg-main); color: var(--text); min-height: 80px; font-family: inherit; resize: vertical;"></textarea>
        </div>
        <div class="profile-field">
            <label>Nomor Rekening Bank</label>
            <input type="text" id="profile-bank-account" placeholder="Nomor rekening...">
        </div>
        <div class="profile-field">
            <label>Nama Bank</label>
            <input type="text" id="profile-bank-name" placeholder="Contoh: BCA, Mandiri, BRI...">
        </div>
        <div class="profile-field">
            <label>NPWP</label>
            <input type="text" id="profile-npwp" placeholder="Nomor NPWP...">
        </div>
        <div class="profile-field">
            <label>BPJS Kesehatan</label>
            <input type="text" id="profile-bpjs-health" placeholder="Nomor BPJS Kesehatan...">
        </div>
        <div class="profile-field">
            <label>BPJS Ketenagakerjaan</label>
            <input type="text" id="profile-bpjs-work" placeholder="Nomor BPJS Ketenagakerjaan...">
        </div>
        <div class="profile-field">
            <label>Kontak Darurat (Nama)</label>
            <input type="text" id="profile-emergency-name" placeholder="Nama kontak darurat...">
        </div>
        <div class="profile-field">
            <label>Kontak Darurat (Hubungan)</label>
            <input type="text" id="profile-emergency-relation" placeholder="Contoh: Ayah, Ibu, Suami, Istri...">
        </div>
        <div class="profile-field">
            <label>Kontak Darurat (Telepon)</label>
            <input type="tel" id="profile-emergency-phone" placeholder="+62 xxx xxxx xxxx">
        </div>
        <div class="profile-field">
            <label>Catatan Tambahan</label>
            <textarea id="profile-notes" placeholder="Informasi tambahan..." style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg-main); color: var(--text); min-height: 60px; font-family: inherit; resize: vertical;"></textarea>
        </div>
        
        <!-- Account Info (Read-only) -->
        <div style="background: var(--bg-soft); border-radius: 10px; padding: 16px; margin-top: 16px; border: 1px solid var(--border);">
            <div style="font-size: 13px; font-weight: 700; margin-bottom: 12px; color: var(--text);">INFO AKUN</div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="font-size: 13px; color: #666;">Role:</span>
                <span id="profile-role" style="font-size: 13px; font-weight: 600; color: var(--primary);">User</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="font-size: 13px; color: #666;">Status:</span>
                <span style="font-size: 13px; font-weight: 600; color: var(--success);">Active</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="font-size: 13px; color: #666;">Last Login:</span>
                <span id="profile-last-login" style="font-size: 13px; font-weight: 600; color: var(--text);">Just now</span>
            </div>
        </div>
    </div>
    <div class="profile-actions">
        <button class="btn-profile secondary" onclick="closeProfile()">BATAL</button>
        <button class="btn-profile primary" onclick="saveProfile()">SIMPAN</button>
    </div>
</div>

<!-- User Management Container (will replace table-container when active) -->
<div id="user-management-container" style="display: none; padding: 20px;">
    <h2 style="margin-bottom: 20px;">ðŸ‘¥ MANAJEMEN USER</h2>
    
    <div style="background: var(--bg-soft); padding: 20px; border-radius: 10px; border: 1px solid var(--border);">
        <table class="user-table">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Nama Lengkap</th>
                    <th>Role</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="user-table-body">
                <!-- User rows will be inserted here -->
            </tbody>
        </table>
    </div>
</div>

<script>
/* ========================================
   MODIFIKASI: ACCORDION BEHAVIOR
   ========================================
   File ini telah dimodifikasi agar sidebar memiliki perilaku "Accordion".
   
   PERUBAHAN UTAMA:
   - Fungsi toggleCat() diubah sehingga hanya 1 kategori yang bisa terbuka dalam 1 waktu
   - Ketika user mengklik kategori baru, kategori lain otomatis tertutup
   - Ini membuat navigasi lebih bersih dan tidak berantakan
   
   NAMA FITUR: Accordion / Exclusive Toggle
   LOKASI KODE: Fungsi toggleCat() (sekitar line 1843)
   
   Tanggal Modifikasi: 30 Januari 2026
   ======================================== */

/* VARIABEL GLOBAL */
let activeKey = 'default';
let isReadOnly = sessionStorage.getItem('erp_role') === 'viewer'; 
let currentPage = 1, rowsPerPage = 10;
let userCurrentPage = 1, userRowsPerPage = 10;
let selectedRowIdx = null, selectedColIdx = null, searchQuery = "";
let dateFilter = { start: "", end: "" };
let openCats = JSON.parse(localStorage.getItem('erp_open_cats')) || ["UTAMA"];
let customPromptCallback = null;
let selectedTables = new Set();
let managementSearchQuery = "";
let managementSortBy = "name"; // name, date, size

/* CUSTOM PROMPT */
function customPrompt(title, placeholder, defaultValue, callback) {
    document.getElementById('prompt-title').innerText = title;
    document.getElementById('custom-prompt-input').placeholder = placeholder;
    document.getElementById('custom-prompt-input').value = defaultValue || '';
    document.getElementById('custom-prompt-modal').classList.add('active');
    document.getElementById('overlay').classList.add('active');
    
    customPromptCallback = callback;
    
    setTimeout(() => {
        document.getElementById('custom-prompt-input').focus();
    }, 100);
    
    document.getElementById('custom-prompt-input').onkeypress = function(e) {
        if (e.key === 'Enter') {
            executeCustomPrompt();
        }
    };
    
    document.getElementById('custom-prompt-ok').onclick = executeCustomPrompt;
}

function executeCustomPrompt() {
    const value = document.getElementById('custom-prompt-input').value;
    closeCustomPrompt();
    if (customPromptCallback) {
        customPromptCallback(value);
        customPromptCallback = null;
    }
}

function closeCustomPrompt() {
    document.getElementById('custom-prompt-modal').classList.remove('active');
    document.getElementById('overlay').classList.remove('active');
    document.getElementById('custom-prompt-input').value = '';
}

/* CUSTOM CONFIRM */
let customConfirmCallback = null;

function customConfirm(title, message, callback) {
    document.getElementById('confirm-title').innerText = title;
    document.getElementById('confirm-message').innerText = message;
    document.getElementById('custom-confirm-modal').classList.add('active');
    document.getElementById('overlay').classList.add('active');
    
    customConfirmCallback = callback;
    
    document.getElementById('custom-confirm-ok').onclick = function() {
        closeCustomConfirm();
        if (customConfirmCallback) {
            customConfirmCallback(true);
            customConfirmCallback = null;
        }
    };
    
    document.getElementById('custom-confirm-cancel').onclick = function() {
        closeCustomConfirm();
        if (customConfirmCallback) {
            customConfirmCallback(false);
            customConfirmCallback = null;
        }
    };
}

function closeCustomConfirm() {
    document.getElementById('custom-confirm-modal').classList.remove('active');
    document.getElementById('overlay').classList.remove('active');
}

/* LOAD DATA DARI LOCAL STORAGE */
let config = JSON.parse(localStorage.getItem('erp_clean_conf')) || {
    default: { title: "DASHBOARD UTAMA", category: "UTAMA", order: 0, cols: ["TANGGAL", "KETERANGAN", "DEBIT", "KREDIT", "SALDO"], lastModified: Date.now(), archived: false }
};
let dataStore = JSON.parse(localStorage.getItem('erp_clean_data')) || {
    default: [["2024-01-01", "Saldo Awal", "0", "0", "0"]]
};

// Migrate old data to include lastModified and archived
Object.keys(config).forEach(key => {
    if (!config[key].lastModified) config[key].lastModified = Date.now();
    if (config[key].archived === undefined) config[key].archived = false;
});

/* INISIALISASI DATE PICKER */
const fp = flatpickr("#dateRangePicker", {
    mode: "range", dateFormat: "Y-m-d",
    onReady: function(s, d, instance) {
        const btn = document.createElement("div");
        btn.innerHTML = "HAPUS FILTER TANGGAL"; btn.className = "flatpickr-clear-button";
        btn.onclick = () => { dateFilter = {start:"", end:""}; instance.clear(); render(); };
        instance.calendarContainer.appendChild(btn);
    },
    onClose: function(s, dateStr) {
        if (s.length === 2) {
            const dates = dateStr.split(" to ");
            dateFilter.start = dates[0]; dateFilter.end = dates[1]; render();
        }
    }
});

/* FUNGSI AUTH */
// LOGIN FUNCTIONS
function toggleLoginPassword() {
    const passwordInput = document.getElementById('login-password');
    const toggleBtn = event.target;
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleBtn.textContent = 'HIDE';
    } else {
        passwordInput.type = 'password';
        toggleBtn.textContent = 'SHOW';
    }
}

function showLoginError(message) {
    const errorDiv = document.getElementById('login-error');
    errorDiv.textContent = message;
    errorDiv.classList.add('show');
    
    setTimeout(() => {
        errorDiv.classList.remove('show');
    }, 4000);
}

function getRecentAccounts() {
    const recent = localStorage.getItem('erp_recent_accounts');
    return recent ? JSON.parse(recent) : [];
}

function saveRecentAccount(username, fullname) {
    let recent = getRecentAccounts();
    
    // Remove if already exists
    recent = recent.filter(acc => acc.username !== username);
    
    // Add to beginning
    recent.unshift({ username, fullname, lastLogin: new Date().toISOString() });
    
    // Keep only last 3 accounts
    recent = recent.slice(0, 3);
    
    localStorage.setItem('erp_recent_accounts', JSON.stringify(recent));
}

function removeRecentAccount(username) {
    let recent = getRecentAccounts();
    recent = recent.filter(acc => acc.username !== username);
    localStorage.setItem('erp_recent_accounts', JSON.stringify(recent));
    displayRecentAccounts();
}

function displayRecentAccounts() {
    const recent = getRecentAccounts();
    const suggestedSection = document.getElementById('login-suggested');
    const accountList = document.getElementById('login-account-list');
    
    if (recent.length === 0) {
        suggestedSection.classList.remove('show');
        return;
    }
    
    suggestedSection.classList.add('show');
    accountList.innerHTML = '';
    
    recent.forEach(account => {
        const initial = account.fullname.charAt(0).toUpperCase();
        const accountItem = document.createElement('div');
        accountItem.className = 'login-account-item';
        accountItem.innerHTML = `
            <div class="login-account-avatar">${initial}</div>
            <div class="login-account-info">
                <div class="login-account-name">${account.fullname}</div>
                <div class="login-account-username">@${account.username}</div>
            </div>
            <button type="button" class="login-account-remove" onclick="event.stopPropagation(); removeRecentAccount('${account.username}')" title="Hapus dari daftar">
                Ã—
            </button>
        `;
        
        accountItem.onclick = () => quickLogin(account.username);
        accountList.appendChild(accountItem);
    });
}

function quickLogin(username) {
    const users = loadUsers();
    const user = users.find(u => u.username === username);
    
    if (user) {
        document.getElementById('login-username').value = username;
        document.getElementById('login-password').focus();
        document.getElementById('login-form').scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
        showLoginError('Akun tidak ditemukan!');
        removeRecentAccount(username);
    }
}

function createDefaultUsersFromLogin() {
    const defaultUsers = [
        {
            username: 'admin',
            password: 'admin',
            fullname: 'RIFAKHI RINDHOI SETIAWAN',
            role: 'Admin'
        },
        {
            username: 'demo',
            password: 'demo123',
            fullname: 'Demo User',
            role: 'User'
        }
    ];
    
    localStorage.setItem('systemUsers', JSON.stringify(defaultUsers));
    showToast('âœ“ User default berhasil dibuat! Username: admin, Password: admin');
}

function handleLoginSubmit(event) {
    event.preventDefault();
    
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    const submitBtn = document.getElementById('login-submit-btn');
    
    if (!username || !password) {
        showLoginError('Username dan Password harus diisi!');
        return;
    }
    
    // Loading state
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    submitBtn.textContent = '';
    
    setTimeout(() => {
        // Initialize users if needed
        initUsers();
        const users = loadUsers();
        const user = users.find(u => u.username === username && u.password === password);
        
        if (user) {
            // Save to recent accounts
            saveRecentAccount(user.username, user.fullname);
            
            // Save session
            sessionStorage.setItem('erp_is_logged', 'true');
            sessionStorage.setItem('erp_role', user.role.toLowerCase());
            sessionStorage.setItem('erp_username', user.fullname);
            
            // Reload to main app
            location.reload();
        } else {
            showLoginError('Username atau Password salah!');
            submitBtn.classList.remove('loading');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Login';
        }
    }, 800);
}

// Legacy login function for compatibility
function login() {
    handleLoginSubmit({ preventDefault: () => {} });
}

function viewMode() {
    sessionStorage.setItem('erp_is_logged', 'true');
    sessionStorage.setItem('erp_role', 'viewer');
    sessionStorage.setItem('erp_username', 'GUEST');
    location.reload();
}

// Check session on page load
if (sessionStorage.getItem('erp_is_logged') === 'true') {
    document.getElementById('login-screen').classList.add('hidden');
    const role = sessionStorage.getItem('erp_role');
    const username = sessionStorage.getItem('erp_username') || 'UNKNOWN';
    const sidebarHeader = document.getElementById('sidebarHeader');
    if (role === 'viewer') {
        sidebarHeader.innerText = username + ' | VIEW';
    } else {
        sidebarHeader.innerText = username + ' | ADMIN';
    }
} else {
    // Show login screen and display recent accounts
    displayRecentAccounts();
}

function logout() { 
    sessionStorage.clear(); 
    location.reload(); 
}

/* UTILITY FUNCTIONS */
function formatDate(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
}

function getDataSize(key) {
    const dataStr = JSON.stringify(dataStore[key] || []);
    const bytes = new Blob([dataStr]).size;
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

/* FUNGSI RENDER UTAMA */
function renderSidebar() {
    const cats = [...new Set(Object.values(config).map(t => t.category || "UTAMA"))];
    let html = '';
    
    const gridIcon = '<span class="grid-icon"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>';
    
    // PROFILE Section (paling atas)
    const isProfileOpen = openCats.includes('PROFILE');
    html += `<div class="cat-group">
        <button class="cat-header" onclick="toggleCat('PROFILE')">
            <span style="display:flex;align-items:center;">${gridIcon}PROFILE</span>
        </button>
        <div class="cat-content ${isProfileOpen ? 'active' : ''}">
            <button class="tab-btn" onclick="openProfilePage()">PENGATURAN AKUN</button>
        </div>
    </div>`;
    
    // USER MANAGEMENT Section (hanya untuk admin)
    if (!isReadOnly) {
        const isUserMgmtOpen = openCats.includes('USER_MGMT');
        html += `<div class="cat-group">
            <button class="cat-header" onclick="toggleCat('USER_MGMT')">
                <span style="display:flex;align-items:center;">${gridIcon}MANAJEMEN USER</span>
            </button>
            <div class="cat-content ${isUserMgmtOpen ? 'active' : ''}">
                <button class="tab-btn" onclick="openUserManagementPage()">KELOLA USER</button>
            </div>
        </div>`;
    }
    
    // Data Tables Section
    cats.forEach(cat => {
        const isOpen = openCats.includes(cat);
        const tables = Object.keys(config)
            .filter(k => (config[k].category || "UTAMA") === cat && !config[k].archived)
            .sort((a,b) => (config[a].order || 0) - (config[b].order || 0));
        
        html += `<div class="cat-group">
            <button class="cat-header" onclick="toggleCat('${cat}')">
                <span style="display:flex;align-items:center;">${gridIcon}${cat}</span>
            </button>
            <div class="cat-content ${isOpen ? 'active' : ''}">
                ${tables.map(k => `<button class="tab-btn ${activeKey === k ? 'active' : ''}" onclick="switchTab('${k}')">${config[k].title.toUpperCase()}</button>`).join('')}
            </div>
        </div>`;
    });
    
    // Archived tables
    const archivedTables = Object.keys(config).filter(k => config[k].archived);
    if (archivedTables.length > 0) {
        const isOpen = openCats.includes('ARSIP');
        html += `<div class="cat-group">
            <button class="cat-header" onclick="toggleCat('ARSIP')">
                <span style="display:flex;align-items:center;">${gridIcon}ARSIP (${archivedTables.length})</span>
            </button>
            <div class="cat-content ${isOpen ? 'active' : ''}">
                ${archivedTables.map(k => `<button class="tab-btn archived ${activeKey === k ? 'active' : ''}" onclick="switchTab('${k}')">${config[k].title.toUpperCase()}</button>`).join('')}
            </div>
        </div>`;
    }
    
    // Settings Section
    const isSettingsOpen = openCats.includes('PENGATURAN');
    html += `<div class="cat-group">
        <button class="cat-header" onclick="toggleCat('PENGATURAN')">
            <span style="display:flex;align-items:center;">${gridIcon}PENGATURAN</span>
        </button>
        <div class="cat-content ${isSettingsOpen ? 'active' : ''}">
            <button class="tab-btn ${isReadOnly ? 'admin-hidden' : ''}" onclick="openTableManager()">MANAJEMEN TABEL</button>
            <button class="tab-btn" onclick="toggleDarkMode()">GANTI TEMA</button>
        </div>
    </div>`;
    
    document.getElementById('sidebar-content').innerHTML = html;
}

function render() {
    try {
        renderSidebar(); 
        
        if (activeKey === '__management__') {
            renderManagement();
            return;
        }
        
        if (activeKey === '__profile__') {
            renderProfilePage();
            return;
        }
        
        if (activeKey === '__usermgmt__') {
            renderUserManagementPage();
            return;
        }
        
        // Check if activeKey exists in config
        if (!config[activeKey]) {
            console.error('Table not found:', activeKey);
            // Redirect to first available table
            const firstTable = Object.keys(config).find(k => !config[k].archived);
            if (firstTable) {
                activeKey = firstTable;
            } else {
                showToast('âš ï¸ Tidak ada tabel yang tersedia');
                return;
            }
        }
        
        // Ensure all required DOM elements exist
        const toolbar = document.querySelector('.toolbar');
        const tableContainer = document.querySelector('.table-container');
        let navBox = document.querySelector('.nav-box');
        const userMgmtContainer = document.getElementById('user-management-container');
        const dispTitle = document.getElementById('disp-title');
        let tableHead = document.getElementById('table-head');
        let tableBody = document.getElementById('table-body');
        let pageInfo = document.getElementById('page-info');
        let totalPagesEl = document.getElementById('totalPages');
        let pageInput = document.getElementById('pageInput');
        
        // If table structure is missing (replaced by user management), restore it
        if (!tableHead || !tableBody || !navBox) {
            console.log('Table structure missing, restoring original HTML...');
            if (tableContainer) {
                tableContainer.innerHTML = `
                    <table id="mainTable">
                        <thead><tr id="table-head"></tr></thead>
                        <tbody id="table-body"></tbody>
                    </table>
                    
                    <div class="nav-box">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <select id="rowsPerPageSelect" onchange="updateRowsPerPage(this.value)" style="border: 1px solid var(--border); border-radius: 3px; font-size: 10px; color: var(--text); background: var(--bg-main); padding: 4px 6px; cursor: pointer; outline: none; min-width: 45px;">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            
                            <button class="btn-ui" onclick="changePage(1)" style="padding: 4px 8px; font-size: 13px; min-width: 30px;" title="First Page">â®</button>
                            <button class="btn-ui" onclick="changePage(currentPage-1)" style="padding: 4px 8px; font-size: 13px; min-width: 30px;" title="Previous">â—€</button>
                            
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span style="font-size: 11px; color: var(--text);">Page</span>
                                <input type="number" id="pageInput" value="1" min="1" max="1" onchange="goToPage(this.value)" style="width: 40px; padding: 4px; border: 1px solid var(--border); border-radius: 3px; text-align: center; font-size: 11px; font-weight: 700; color: var(--primary);">
                                <span style="font-size: 11px; color: var(--text);">of <span id="totalPages">1</span></span>
                            </div>
                            
                            <button class="btn-ui" onclick="changePage(currentPage+1)" style="padding: 4px 8px; font-size: 13px; min-width: 30px;" title="Next">â–¶</button>
                            <button class="btn-ui" onclick="changePage(1)" style="padding: 4px 8px; font-size: 13px; min-width: 30px;" title="Last Page">â­</button>
                            
                            <button class="btn-ui" onclick="render()" style="padding: 4px 8px; font-size: 13px; min-width: 30px;" title="Refresh">â†»</button>
                        </div>
                        
                        <div id="page-info" style="font-size: 10px; color: var(--text); font-weight: 600;">Displaying 0 to 0 of 0 items</div>
                    </div>
                `;
                
                // Re-get elements after restoration
                navBox = document.querySelector('.nav-box');
                tableHead = document.getElementById('table-head');
                tableBody = document.getElementById('table-body');
                pageInfo = document.getElementById('page-info');
                totalPagesEl = document.getElementById('totalPages');
                pageInput = document.getElementById('pageInput');
                
                console.log('âœ“ Table structure restored');
            }
        }
        
        // Check each element and report which ones are missing
        const missingElements = [];
        if (!toolbar) missingElements.push('toolbar (.toolbar)');
        if (!tableContainer) missingElements.push('tableContainer (.table-container)');
        if (!navBox) missingElements.push('navBox (.nav-box)');
        if (!dispTitle) missingElements.push('dispTitle (#disp-title)');
        if (!tableHead) missingElements.push('tableHead (#table-head)');
        if (!tableBody) missingElements.push('tableBody (#table-body)');
        
        if (missingElements.length > 0) {
            const errorMsg = 'Missing DOM elements: ' + missingElements.join(', ');
            console.error(errorMsg);
            console.error('Document ready state:', document.readyState);
            throw new Error(errorMsg);
        }
        
        toolbar.style.display = 'flex';
        tableContainer.style.display = 'block';
        navBox.style.display = 'flex';
        if (userMgmtContainer) userMgmtContainer.style.display = 'none';
        
        const isArchived = config[activeKey]?.archived;
        dispTitle.innerText = config[activeKey].title + (isArchived ? ' (ARSIP)' : '');
        
        let allCols = config[activeKey].cols;
        let hHtml = `<th class="row-num">ID</th>`;
        allCols.forEach((c, i) => { 
            hHtml += `<th><div class="th-inner" onclick="${isReadOnly ? '' : `openFilter(${i})`}">${c} ${isReadOnly ? '' : '<span style="font-size:9px;">EDIT</span>'}</div></th>`; 
        });
        tableHead.innerHTML = hHtml;
        
        // Initialize dataStore for this table if it doesn't exist
        if (!dataStore[activeKey]) {
            dataStore[activeKey] = [];
        }
        
        let filtered = dataStore[activeKey].map((row, index) => ({row, index}));
        if(searchQuery) filtered = filtered.filter(i => i.row.some(c => c.toString().toLowerCase().includes(searchQuery.toLowerCase())));
        if(dateFilter.start && dateFilter.end) filtered = filtered.filter(i => { let d = (i.row[0] || "").trim(); return d >= dateFilter.start && d <= dateFilter.end; });
        
        let totalPages = Math.ceil(filtered.length / rowsPerPage) || 1;
        let paginated = filtered.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);
        
        tableBody.innerHTML = paginated.map(item => `<tr>
            <td class="row-num" onclick="${isReadOnly ? '' : `openPopUp(${item.index})`}">${item.index + 1}</td>
            ${item.row.map((cell, ci) => `<td><input type="text" value="${cell}" ${isReadOnly ? 'readonly' : ''} oninput="upd(${item.index},${ci},this.value)"></td>`).join('')}
        </tr>`).join('');
        
        // Update pagination info
        const startItem = filtered.length === 0 ? 0 : ((currentPage - 1) * rowsPerPage) + 1;
        const endItem = Math.min(currentPage * rowsPerPage, filtered.length);
        if (pageInfo) pageInfo.innerText = `Displaying ${startItem} to ${endItem} of ${filtered.length} items`;
        if (totalPagesEl) totalPagesEl.innerText = totalPages;
        if (pageInput) {
            pageInput.value = currentPage;
            pageInput.max = totalPages;
        }
        
        if (isReadOnly) {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn[onclick="openTableManager()"]').forEach(el => el.style.display = 'none');
        }
    } catch (error) {
        console.error('=== ERROR RENDERING TABLE ===');
        console.error('Error:', error);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        console.error('ActiveKey:', activeKey);
        console.error('Config exists:', !!config[activeKey]);
        console.error('DataStore exists:', !!dataStore[activeKey]);
        console.error('=== END ERROR ===');
        
        // Safe toast notification
        try {
            const toastEl = document.getElementById('toast');
            if (toastEl) {
                toastEl.innerText = 'Error: ' + error.message;
                toastEl.classList.add('active');
                setTimeout(() => toastEl.classList.remove('active'), 5000);
            } else {
                alert('Error: ' + error.message);
            }
        } catch (e) {
            console.error('Failed to show toast:', e);
        }
        
        // Try to load the first available table
        try {
            const firstTable = Object.keys(config).find(k => !config[k].archived);
            if (firstTable && firstTable !== activeKey) {
                console.log('Attempting to switch to first table:', firstTable);
                activeKey = firstTable;
                setTimeout(() => {
                    try {
                        render();
                    } catch (retryError) {
                        console.error('Failed to render first table:', retryError);
                    }
                }, 500);
            }
        } catch (e) {
            console.error('Failed to load first table:', e);
        }
    }
}

function renderManagement() {
    document.getElementById('disp-title').innerText = 'MANAJEMEN TABEL';
    
    document.querySelector('.toolbar').style.display = 'none';
    document.querySelector('.nav-box').style.display = 'none';
    
    const container = document.querySelector('.table-container');
    container.style.display = 'block';
    
    // Get all tables
    let allTables = Object.keys(config)
        .filter(k => k !== '__management__')
        .map(key => ({
            key: key,
            title: config[key].title,
            category: config[key].category || 'UTAMA',
            order: config[key].order || 0,
            cols: config[key].cols.length,
            rows: dataStore[key] ? dataStore[key].length : 0,
            lastModified: config[key].lastModified || Date.now(),
            archived: config[key].archived || false,
            size: getDataSize(key)
        }));
    
    // Apply search filter
    if (managementSearchQuery) {
        allTables = allTables.filter(t => 
            t.title.toLowerCase().includes(managementSearchQuery.toLowerCase()) ||
            t.category.toLowerCase().includes(managementSearchQuery.toLowerCase())
        );
    }
    
    // Apply sorting
    allTables.sort((a, b) => {
        if (managementSortBy === 'name') {
            return a.title.localeCompare(b.title);
        } else if (managementSortBy === 'date') {
            return b.lastModified - a.lastModified;
        } else if (managementSortBy === 'size') {
            const sizeA = JSON.stringify(dataStore[a.key] || []).length;
            const sizeB = JSON.stringify(dataStore[b.key] || []).length;
            return sizeB - sizeA;
        }
        return 0;
    });
    
    // Calculate statistics
    const totalTables = allTables.filter(t => !t.archived).length;
    const totalRows = allTables.reduce((sum, t) => sum + t.rows, 0);
    const totalCols = allTables.reduce((sum, t) => sum + t.cols, 0);
    const archivedCount = allTables.filter(t => t.archived).length;
    
    // Group by category
    const grouped = {};
    allTables.forEach(table => {
        const cat = table.archived ? 'ARSIP' : table.category;
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(table);
    });
    
    let categoryHTML = '';
    Object.keys(grouped).forEach(category => {
        let tablesHTML = '';
        grouped[category].forEach(table => {
            const isSelected = selectedTables.has(table.key);
            tablesHTML += `
                <div class="management-card ${isSelected ? 'selected' : ''} ${table.archived ? 'archived' : ''}" data-key="${table.key}">
                    <div style="display: flex; align-items: start; gap: 8px;">
                        <div class="checkbox-card ${isSelected ? 'checked' : ''}" onclick="toggleSelectTable('${table.key}')"></div>
                        <div style="flex-grow: 1;">
                            <div style="font-size: 12px; font-weight: 800; color: var(--primary); margin-bottom: 4px; line-height: 1.2;">
                                ${table.title}
                                ${table.archived ? '<span class="badge badge-archive">ARSIP</span>' : ''}
                            </div>
                            <div style="display: flex; gap: 10px; font-size: 10px; color: #888; margin-bottom: 4px; flex-wrap: wrap;">
                                <span><strong style="color: var(--text);">${table.cols}</strong> Kolom</span>
                                <span><strong style="color: var(--text);">${table.rows}</strong> Baris</span>
                                <span>${table.category}</span>
                                <span>${table.size}</span>
                            </div>
                            <div style="font-size: 9px; color: #aaa; margin-bottom: 6px;">
                                ${formatDate(table.lastModified)} ${formatTime(table.lastModified)}
                            </div>
                            <div class="card-actions">
                                <button class="btn-action primary" onclick="previewTable('${table.key}')">PREVIEW</button>
                                <button class="btn-action" onclick="duplicateTable('${table.key}')">DUPLIKAT</button>
                                <button class="btn-action" onclick="renameTableByKey('${table.key}')">EDIT</button>
                                <button class="btn-action" onclick="changeCategoryByKey('${table.key}')">KATEGORI</button>
                                <button class="btn-action warning" onclick="toggleArchive('${table.key}')">${table.archived ? 'RESTORE' : 'ARSIP'}</button>
                                <button class="btn-action danger" onclick="deleteTableByKey('${table.key}')">HAPUS</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        categoryHTML += `
            <div class="category-section">
                <div class="category-title">
                    <h3>${category}</h3>
                    <span class="category-count">${grouped[category].length}</span>
                </div>
                ${tablesHTML}
            </div>
        `;
    });
    
    container.innerHTML = `
        <div style="padding: 12px; max-width: 1200px; margin: 0 auto;">
            <!-- Minimal Stats Info -->
            <div style="background: var(--bg-soft); border-radius: 6px; padding: 8px 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border);">
                <div style="font-size: 11px; color: #666;">
                    <strong>Total Tabel: ${totalTables}</strong> | Baris: ${totalRows} | Kolom: ${totalCols} | Arsip: ${archivedCount}
                </div>
            </div>
            
            <!-- Search and Filter Bar -->
            <div class="search-filter-bar">
                <input type="text" id="mgmt-search" placeholder="Cari tabel..." value="${managementSearchQuery}" oninput="updateManagementSearch(this.value)">
                <select id="mgmt-sort" onchange="updateManagementSort(this.value)">
                    <option value="name" ${managementSortBy === 'name' ? 'selected' : ''}>Nama A-Z</option>
                    <option value="date" ${managementSortBy === 'date' ? 'selected' : ''}>Terbaru</option>
                    <option value="size" ${managementSortBy === 'size' ? 'selected' : ''}>Terbesar</option>
                </select>
            </div>
            
            <!-- Bulk Actions Bar -->
            <div class="bulk-actions-bar ${selectedTables.size > 0 ? 'active' : ''}" id="bulk-actions">
                <span style="font-size: 11px; font-weight: 700; color: var(--primary); flex-grow: 1;">${selectedTables.size} tabel dipilih</span>
                <button class="btn-ui" onclick="bulkArchive()">ARSIP</button>
                <button class="btn-ui" onclick="bulkDelete()" style="color: var(--danger);">HAPUS</button>
                <button class="btn-ui" onclick="clearSelection()">BATAL</button>
            </div>
            
            <!-- Action Buttons -->
            <div class="management-actions">
                <button class="btn-action-main btn-create" onclick="createNewTable()">+ BUAT</button>
                <button class="btn-action-main btn-export" onclick="exportAllTables()">EXPORT</button>
                <button class="btn-action-main btn-backup" onclick="backupAllData()">BACKUP</button>
                <button class="btn-action-main btn-restore" onclick="document.getElementById('restore-file').click()">RESTORE</button>
                <input type="file" id="restore-file" hidden accept=".json" onchange="restoreAllData(event)">
            </div>
            
            ${categoryHTML}
        </div>
    `;
}

/* MANAGEMENT FUNCTIONS */
function updateManagementSearch(value) {
    managementSearchQuery = value;
    render();
}

function updateManagementSort(value) {
    managementSortBy = value;
    render();
}

function toggleSelectTable(key) {
    if (selectedTables.has(key)) {
        selectedTables.delete(key);
    } else {
        selectedTables.add(key);
    }
    render();
}

function clearSelection() {
    selectedTables.clear();
    render();
}

function bulkArchive() {
    if (selectedTables.size === 0) return;
    customConfirm(
        'ARSIPKAN TABEL',
        `Arsipkan ${selectedTables.size} tabel yang dipilih?`,
        function(confirmed) {
            if (confirmed) {
                selectedTables.forEach(key => {
                    config[key].archived = true;
                    config[key].lastModified = Date.now();
                });
                autoSave();
                clearSelection();
                showToast(`${selectedTables.size} tabel diarsipkan!`);
            }
        }
    );
}

function bulkDelete() {
    if (selectedTables.size === 0) return;
    customConfirm(
        'HAPUS TABEL',
        `PERINGATAN: Hapus ${selectedTables.size} tabel yang dipilih? Data akan hilang permanen!`,
        function(confirmed) {
            if (confirmed) {
                selectedTables.forEach(key => {
                    delete config[key];
                    delete dataStore[key];
                });
                autoSave();
                clearSelection();
                showToast(`${selectedTables.size} tabel dihapus!`);
            }
        }
    );
}

function duplicateTable(key) {
    if (!config[key]) return;
    
    customPrompt('DUPLIKAT TABEL', 'Nama untuk salinan tabel...', config[key].title + ' (Salinan)', function(newName) {
        if (newName && newName.trim()) {
            const newKey = 't' + Date.now();
            config[newKey] = {
                ...config[key],
                title: newName.trim().toUpperCase(),
                order: 999,
                lastModified: Date.now(),
                archived: false
            };
            dataStore[newKey] = JSON.parse(JSON.stringify(dataStore[key] || []));
            autoSave();
            render();
            showToast('Tabel berhasil diduplikasi!');
        }
    });
}

function toggleArchive(key) {
    if (!config[key]) return;
    config[key].archived = !config[key].archived;
    config[key].lastModified = Date.now();
    autoSave();
    render();
    showToast(config[key].archived ? 'Tabel diarsipkan!' : 'Tabel di-restore!');
}

function previewTable(key) {
    if (!config[key] || !dataStore[key]) return;
    
    const table = config[key];
    const data = dataStore[key];
    
    let html = `
        <div style="margin-bottom: 15px;">
            <div style="font-size: 16px; font-weight: 700; color: var(--primary); margin-bottom: 5px;">${table.title}</div>
            <div style="font-size: 12px; color: #888;">
                ${table.cols.length} kolom Ã— ${data.length} baris | ${table.category}
            </div>
        </div>
        <div class="preview-table">
            <table style="width: 100%; table-layout: auto;">
                <thead>
                    <tr>${table.cols.map(col => `<th>${col}</th>`).join('')}</tr>
                </thead>
                <tbody>
                    ${data.slice(0, 10).map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}
                </tbody>
            </table>
        </div>
        ${data.length > 10 ? `<div style="text-align: center; margin-top: 10px; font-size: 11px; color: #888;">Menampilkan 10 dari ${data.length} baris</div>` : ''}
    `;
    
    document.getElementById('preview-content').innerHTML = html;
    document.getElementById('sheet-preview').classList.add('active');
    document.getElementById('overlay').classList.add('active');
}

function closePreview() {
    document.getElementById('sheet-preview').classList.remove('active');
    document.getElementById('overlay').classList.remove('active');
}

function exportAllTables() {
    const wb = XLSX.utils.book_new();
    
    Object.keys(config).forEach(key => {
        if (key === '__management__') return;
        
        const table = config[key];
        const data = dataStore[key] || [];
        const sheetData = [table.cols, ...data];
        
        let sheetName = table.title.substring(0, 31); // Excel limit
        sheetName = sheetName.replace(/[:\\/?*\[\]]/g, '_'); // Remove invalid chars
        
        const ws = XLSX.utils.aoa_to_sheet(sheetData);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
    });
    
    const timestamp = new Date().toISOString().split('T')[0];
    XLSX.writeFile(wb, `ERP_All_Tables_${timestamp}.xlsx`);
    showToast('Semua tabel berhasil di-export!');
}

function backupAllData() {
    const backup = {
        version: '1.0',
        timestamp: Date.now(),
        config: config,
        data: dataStore
    };
    
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ERP_Backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Backup berhasil dibuat!');
}

function restoreAllData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);
            
            if (!backup.config || !backup.data) {
                alert('File backup tidak valid!');
                return;
            }
            
            customConfirm(
                'RESTORE BACKUP',
                'PERINGATAN: Restore akan menimpa semua data yang ada. Lanjutkan?',
                function(confirmed) {
                    if (confirmed) {
                        config = backup.config;
                        dataStore = backup.data;
                        autoSave();
                        render();
                        showToast('Data berhasil di-restore!');
                    }
                }
            );
        } catch (err) {
            alert('Error membaca file backup: ' + err.message);
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function showToast(message) {
    try {
        const toast = document.getElementById('toast');
        if (!toast) {
            console.warn('Toast element not found, using alert instead');
            alert(message);
            return;
        }
        // Hapus semua emoji dari pesan
        const cleanMsg = message.replace(/[\u{1F300}-\u{1F9FF}]/gu, '').replace(/[â­ðŸ‘¤ðŸ‘¥ðŸ“‹ðŸ’¾ðŸ”„âœ…âŒâš ï¸â—âœ“â³]/g, '').trim();
        toast.innerText = cleanMsg || 'Notification';
        toast.classList.add('active');
        setTimeout(() => {
            toast.classList.remove('active');
        }, 3000);
    } catch (error) {
        console.error('Error in showToast:', error);
        try {
            alert(message);
        } catch (e) {
            console.error('Failed to show alert:', e);
        }
    }
}

/* FUNGSI MANAJEMEN DATA */
function autoSave() { 
    if (isReadOnly) return;
    // Update lastModified for current table
    if (activeKey && config[activeKey]) {
        config[activeKey].lastModified = Date.now();
    }
    localStorage.setItem('erp_clean_conf', JSON.stringify(config)); 
    localStorage.setItem('erp_clean_data', JSON.stringify(dataStore)); 
}

function updateRowsPerPage(val) { rowsPerPage = parseInt(val); currentPage = 1; render(); }

function toggleCat(cat) {
    // ACCORDION BEHAVIOR: Tutup semua kategori lain kecuali yang diklik
    if(openCats.includes(cat)) {
        // Jika sudah terbuka, tutup
        openCats = openCats.filter(c => c !== cat);
    } else {
        // Jika belum terbuka, tutup semua kategori lain dan buka yang ini
        openCats = [cat]; // Hanya simpan kategori yang diklik
    }
    localStorage.setItem('erp_open_cats', JSON.stringify(openCats)); 
    renderSidebar();
}

function switchTab(k) {
    try {
        console.log('=== SWITCHING TO TABLE ===');
        console.log('Target table:', k);
        console.log('Config exists:', !!config[k]);
        
        // Validate table exists
        if (!config[k]) {
            console.error('Table config not found for:', k);
            showToast('Tabel tidak ditemukan: ' + k);
            return;
        }
        
        activeKey = k; 
        currentPage = 1;
        
        // Save to localStorage
        try {
            localStorage.setItem('erp_activeKey', activeKey);
        } catch (e) {
            console.warn('Failed to save activeKey to localStorage:', e);
        }
        
        console.log('Calling render()...');
        render(); 
        
        console.log('Calling closeAll()...');
        closeAll();
        
        // Scroll to top when switching tabs
        console.log('Scrolling to top...');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        console.log('=== SWITCH COMPLETE ===');
    } catch (error) {
        console.error('=== ERROR IN SWITCHTAB ===');
        console.error('Error:', error);
        console.error('Target table:', k);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        
        try {
            const toastEl = document.getElementById('toast');
            if (toastEl) {
                toastEl.innerText = 'Error switching table: ' + error.message;
                toastEl.classList.add('active');
                setTimeout(() => toastEl.classList.remove('active'), 5000);
            }
        } catch (e) {
            console.error('Failed to show error toast:', e);
        }
    }
}

function upd(r, c, v) { 
    if(isReadOnly) return; 
    dataStore[activeKey][r][c] = v; 
    autoSave(); 
}

function doSearch() { searchQuery = document.getElementById('searchInp').value; currentPage = 1; render(); }

/* UI CONTROL */
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }

function openPopUp(idx) { if(isReadOnly) return; selectedRowIdx = idx; document.getElementById('sheet-menu').classList.add('active'); document.getElementById('overlay').classList.add('active'); }

function openFilter(colIdx) { if(isReadOnly) return; selectedColIdx = colIdx; document.getElementById('sheet-filter').classList.add('active'); document.getElementById('overlay').classList.add('active'); }

function openTableManager() { 
    if(isReadOnly) return; 
    activeKey = '__management__'; 
    selectedTables.clear();
    managementSearchQuery = "";
    render(); 
    closeAll();
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function closeModal() { document.querySelectorAll('.sheet').forEach(s => s.classList.remove('active')); document.getElementById('overlay').classList.remove('active'); }

function closeAll() { 
    closeModal(); 
    // Only close sidebar on mobile (screen width < 992px)
    if (window.innerWidth < 992) {
        document.getElementById('sidebar').classList.remove('active'); 
        document.getElementById('overlay').classList.remove('active');
    }
}

function toggleDarkMode() { 
    document.body.classList.toggle('dark-mode'); 
    localStorage.setItem('erp_dark', document.body.classList.contains('dark-mode')); 
}
if(localStorage.getItem('erp_dark') === 'true') document.body.classList.add('dark-mode');

/* AKSI TABEL */
function handleSortData(dir) { 
    dataStore[activeKey].sort((a, b) => { 
        let vA = (a[selectedColIdx] || "").toString(), vB = (b[selectedColIdx] || "").toString(); 
        return dir === 'asc' ? vA.localeCompare(vB) : vB.localeCompare(vA); 
    }); 
    autoSave(); render(); closeModal(); 
}

function handleExecAction(type) {
    if (isReadOnly) return;
    if (type === 'add_row') dataStore[activeKey].push(new Array(config[activeKey].cols.length).fill(""));
    if (type === 'add_col') { 
        customPrompt('KOLOM BARU', 'Nama kolom baru...', '', function(n) {
            if(n && n.trim()){
                config[activeKey].cols.push(n.trim().toUpperCase()); 
                dataStore[activeKey].forEach(r=>r.push(""));
                autoSave();
                render();
                closeModal();
            }
        });
        return;
    }
    if (type === 'edit_header') { 
        customPrompt('GANTI NAMA KOLOM', 'Nama baru...', config[activeKey].cols[selectedColIdx], function(n) {
            if(n && n.trim()) {
                config[activeKey].cols[selectedColIdx]=n.trim().toUpperCase();
                autoSave();
                render();
                closeModal();
            }
        });
        return;
    }
    if (type === 'del_row') dataStore[activeKey].splice(selectedRowIdx, 1);
    if (type === 'del_col') { config[activeKey].cols.splice(selectedColIdx, 1); dataStore[activeKey].forEach(r=>r.splice(selectedColIdx,1)); }
    if (type === 'clear_all') {
        customConfirm('HAPUS SEMUA', 'Hapus semua isi tabel?', function(confirmed) {
            if (confirmed) {
                dataStore[activeKey] = [];
                autoSave();
                render();
                closeModal();
            }
        });
        return;
    }
    autoSave(); render(); closeModal();
}

function fillColCurrentDate() { 
    if(isReadOnly) return; 
    let d = new Date().toISOString().split('T')[0]; 
    dataStore[activeKey].forEach(r => r[selectedColIdx] = d); 
    autoSave(); render(); closeModal(); 
}

/* EXPORT / IMPORT */
function exportToExcel() { 
    let ws = XLSX.utils.aoa_to_sheet([config[activeKey].cols, ...dataStore[activeKey]]); 
    let wb = XLSX.utils.book_new(); 
    XLSX.utils.book_append_sheet(wb, ws, "Data"); 
    XLSX.writeFile(wb, config[activeKey].title + ".xlsx"); 
}

function importFromExcel(e) { 
    if(isReadOnly) return; 
    let f = e.target.files[0]; if(!f) return; 
    let r = new FileReader(); 
    r.onload = (ex) => { 
        let d = new Uint8Array(ex.target.result), wb = XLSX.read(d, {type:'array'}); 
        let rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1, defval:""}); 
        if(rows.length > 0) { 
            config[activeKey].cols = rows[0].map(h => h.toString().toUpperCase()); 
            rows.shift(); dataStore[activeKey] = rows; autoSave(); render(); 
        } 
    }; 
    r.readAsArrayBuffer(f); 
}

/* MANAJEMEN TABEL LANJUTAN */
function openCatPicker() {
    if(isReadOnly) return;
    const cats = [...new Set(Object.values(config).map(t => t.category || "UTAMA"))];
    let html = '<p style="font-size:12px; margin-bottom:10px; color:grey;">Pilih Kategori:</p>';
    cats.forEach(c => { html += `<div class="cat-item-select" onclick="selectExistingCat('${c}')">FOLDER: ${c}</div>`; });
    document.getElementById('cat-list-box').innerHTML = html;
    document.getElementById('sheet-cat-picker').classList.add('active');
}

function selectExistingCat(catName) { 
    config[activeKey].category = catName; 
    autoSave(); 
    render(); 
    closeCatPicker(); 
    closeModal(); 
}

function applyNewCat() { 
    let val = document.getElementById('newCatInp').value; 
    if(val) { 
        selectExistingCat(val.toUpperCase()); 
        document.getElementById('newCatInp').value = ""; 
    } 
}

function closeCatPicker() { document.getElementById('sheet-cat-picker').classList.remove('active'); }

function renameTable() { 
    if(isReadOnly) return; 
    const firstKey = Object.keys(config).find(k => k !== '__management__');
    if (!firstKey) return;
    customPrompt('UBAH NAMA TABEL', 'Nama baru...', config[firstKey].title, function(n) {
        if(n && n.trim()){
            config[firstKey].title = n.trim().toUpperCase(); 
            autoSave(); 
            activeKey = firstKey;
            render();
        }
    });
}

function moveTable(dir) {
    if(isReadOnly) return;
    const firstKey = Object.keys(config).find(k => k !== '__management__');
    if (!firstKey) return;
    let keys = Object.keys(config).filter(k => k !== '__management__' && config[k].category === config[firstKey].category).sort((a,b) => (config[a].order || 0) - (config[b].order || 0));
    let idx = keys.indexOf(firstKey);
    if(dir==='up' && idx > 0) [config[keys[idx]].order, config[keys[idx-1]].order] = [config[keys[idx-1]].order, config[keys[idx]].order];
    else if(dir==='down' && idx < keys.length-1) [config[keys[idx]].order, config[keys[idx+1]].order] = [config[keys[idx+1]].order, config[keys[idx]].order];
    autoSave(); 
    render();
}

function createNewTable() { 
    if(isReadOnly) return;
    customPrompt('BUAT TABEL BARU', 'Nama tabel...', '', function(n) {
        if (n && n.trim() !== '') { 
            let k = 't' + Date.now();
            const allKeys = Object.keys(config).filter(k => k !== '__management__');
            const category = allKeys.length > 0 ? config[allKeys[0]].category : 'UTAMA';
            config[k] = { 
                title: n.trim().toUpperCase(), 
                category: category, 
                order: 99, 
                cols: ["TANGGAL", "KETERANGAN"],
                lastModified: Date.now(),
                archived: false
            }; 
            dataStore[k] = [[new Date().toISOString().split('T')[0], ""]]; 
            autoSave(); 
            activeKey = '__management__';
            render();
            showToast('Tabel baru berhasil dibuat!');
        }
    });
}

function deleteCurrentTable() { 
    const firstKey = Object.keys(config).find(k => k !== '__management__');
    if(!isReadOnly && Object.keys(config).length > 1 && firstKey){ 
        customConfirm('HAPUS TABEL', 'Hapus tabel ini?', function(confirmed) {
            if (confirmed) {
                delete config[firstKey]; 
                delete dataStore[firstKey]; 
                activeKey = Object.keys(config).find(k => k !== '__management__') || 'default'; 
                autoSave(); 
                render();
            }
        });
    } 
}

function deleteCategory() {
    if(isReadOnly) return;
    const cats = [...new Set(Object.values(config).filter(c => c.category).map(t => t.category))];
    let catList = cats.join(', ');
    customPrompt('HAPUS KATEGORI', `Ketik nama: ${catList}`, '', function(cat) {
        if(cat && cat.trim()) {
            customConfirm(
                'KONFIRMASI HAPUS KATEGORI',
                `Hapus kategori "${cat.toUpperCase()}"? Semua tabel akan dipindahkan ke kategori UTAMA.`,
                function(confirmed) {
                    if(confirmed) {
                        Object.keys(config).forEach(k => { 
                            if(k !== '__management__' && config[k].category === cat.toUpperCase()) 
                                config[k].category = "UTAMA"; 
                        });
                        autoSave();
                        activeKey = '__management__';
                        render();
                    }
                }
            );
        }
    });
}

function changePage(p) { 
    if (activeKey === '__management__') return;
    if (!dataStore[activeKey]) return;
    let t = Math.ceil(dataStore[activeKey].length/rowsPerPage) || 1; 
    if(p >= 1 && p <= t) { currentPage = p; render(); } 
}

function goToPage(pageNum) {
    const page = parseInt(pageNum);
    if (!isNaN(page)) {
        changePage(page);
    }
}

// User management pagination functions
function changeUserPage(p) {
    const users = loadUsers();
    let totalPages = Math.ceil(users.length / userRowsPerPage) || 1;
    if (p >= 1 && p <= totalPages) {
        userCurrentPage = p;
        renderUserManagementPage();
    }
}

function goToUserPage(pageNum) {
    const page = parseInt(pageNum);
    if (!isNaN(page)) {
        changeUserPage(page);
    }
}

function updateUserRowsPerPage(value) {
    userRowsPerPage = parseInt(value);
    userCurrentPage = 1; // Reset to first page
    renderUserManagementPage();
}

function renameTableByKey(key) {
    if(isReadOnly) return;
    customPrompt('UBAH NAMA TABEL', 'Nama baru...', config[key].title, function(n) {
        if(n && n.trim()) {
            config[key].title = n.trim().toUpperCase();
            config[key].lastModified = Date.now();
            autoSave();
            render();
        }
    });
}

function changeCategoryByKey(key) {
    if(isReadOnly) return;
    const cats = [...new Set(Object.values(config).filter(c => c.category).map(t => t.category))];
    let catList = cats.join(', ');
    customPrompt('PINDAH KATEGORI', `Ketik: ${catList} atau buat baru`, config[key].category, function(choice) {
        if(choice && choice.trim()) {
            config[key].category = choice.trim().toUpperCase();
            config[key].lastModified = Date.now();
            autoSave();
            render();
        }
    });
}

function deleteTableByKey(key) {
    if(isReadOnly) return;
    if(Object.keys(config).filter(k => k !== '__management__').length <= 1) {
        alert("Tidak bisa menghapus tabel terakhir!");
        return;
    }
    
    customConfirm(
        'HAPUS TABEL',
        `Apakah Anda yakin ingin menghapus tabel "${config[key].title}"? Tindakan ini tidak dapat dibatalkan.`,
        function(confirmed) {
            if(confirmed) {
                delete config[key];
                delete dataStore[key];
                selectedTables.delete(key);
                autoSave();
                render();
                showToast('Tabel berhasil dihapus!');
            }
        }
    );
}

/* ========== PROFILE FUNCTIONS ========== */
function openProfilePage() {
    activeKey = '__profile__';
    render();
    closeAll();
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function renderProfilePage() {
    // Hide table elements
    document.querySelector('.toolbar').style.display = 'none';
    document.querySelector('.table-container').style.display = 'none';
    document.querySelector('.nav-box').style.display = 'none';
    document.getElementById('user-management-container').style.display = 'none';
    
    document.getElementById('disp-title').innerText = 'PROFILE PENGGUNA';
    
    // Load profile data
    const profileData = JSON.parse(localStorage.getItem('userProfile') || '{}');
    
    // Create profile page HTML
    const profileHTML = `
        <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
            <div style="background: var(--bg-soft); padding: 30px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 20px;">
                <h3 style="margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid var(--border); padding-bottom: 10px;">INFORMASI PROFILE</h3>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #666;">Nama Lengkap</label>
                    <input type="text" id="profile-name" value="${profileData.name || ''}" placeholder="Masukkan nama lengkap..." style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg-main); color: var(--text);">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #666;">Email</label>
                    <input type="email" id="profile-email" value="${profileData.email || ''}" placeholder="email@example.com" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg-main); color: var(--text);">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #666;">Nomor Telepon</label>
                    <input type="tel" id="profile-phone" value="${profileData.phone || ''}" placeholder="+62 xxx xxxx xxxx" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg-main); color: var(--text);">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #666;">Jabatan / Posisi</label>
                    <input type="text" id="profile-position" value="${profileData.position || ''}" placeholder="Posisi Anda..." style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg-main); color: var(--text);">
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                    <button onclick="switchTab(Object.keys(config).find(k => k !== '__management__') || 'default')" style="padding: 12px 24px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text); font-weight: 600; cursor: pointer; font-size: 14px;">BATAL</button>
                    <button onclick="saveProfilePage()" style="padding: 12px 24px; border-radius: 8px; border: 2px solid var(--primary); background: transparent; color: var(--primary); font-weight: 600; cursor: pointer; font-size: 14px;">SIMPAN</button>
                </div>
            </div>
        </div>
    `;
    
    document.querySelector('.table-container').innerHTML = profileHTML;
    document.querySelector('.table-container').style.display = 'block';
}

function saveProfilePage() {
    const profileData = {
        name: document.getElementById('profile-name').value.trim(),
        email: document.getElementById('profile-email').value.trim(),
        phone: document.getElementById('profile-phone').value.trim(),
        position: document.getElementById('profile-position').value.trim()
    };
    
    localStorage.setItem('userProfile', JSON.stringify(profileData));
    
    // Update sidebar if name changed
    if (profileData.name) {
        sessionStorage.setItem('erp_username', profileData.name);
        const role = sessionStorage.getItem('erp_role');
        const sidebarHeader = document.getElementById('sidebarHeader');
        if (role === 'viewer') {
            sidebarHeader.innerText = profileData.name + ' | VIEW';
        } else {
            sidebarHeader.innerText = profileData.name + ' | ADMIN';
        }
    }
    
    showToast('âœ… Profile berhasil disimpan!');
}

// Remove old modal functions
function openProfile() { 
    // Load profile data
    const profileData = JSON.parse(localStorage.getItem('userProfile') || '{}');
    const currentUsername = sessionStorage.getItem('erp_username') || 'admin';
    const users = loadUsers();
    const user = users.find(u => u.username === currentUsername || u.fullname === currentUsername);
    
    // Calculate statistics
    let totalTables = 0;
    let totalRecords = 0;
    Object.keys(config).forEach(k => {
        if (k !== '__management__') {
            totalTables++;
            if (config[k] && config[k].data) {
                totalRecords += config[k].data.length;
            }
        }
    });
    
    // Prioritas: 1. Data dari systemUsers, 2. Data dari userProfile, 3. Default
    const fullname = user ? user.fullname : (profileData.name || currentUsername);
    const username = user ? user.username : currentUsername;
    const role = user ? user.role : 'Admin';
    
    // Update form fields - gunakan data dari userProfile untuk field editable
    document.getElementById('profile-name').value = fullname;
    document.getElementById('profile-nik').value = profileData.nik || '';
    document.getElementById('profile-birthdate').value = profileData.birthdate || '';
    document.getElementById('profile-birthplace').value = profileData.birthplace || '';
    document.getElementById('profile-gender').value = profileData.gender || '';
    document.getElementById('profile-email').value = profileData.email || '';
    document.getElementById('profile-phone').value = profileData.phone || '';
    document.getElementById('profile-religion').value = profileData.religion || '';
    document.getElementById('profile-marital').value = profileData.marital || '';
    document.getElementById('profile-nationality').value = profileData.nationality || 'Indonesia';
    document.getElementById('profile-position').value = profileData.position || '';
    document.getElementById('profile-department').value = profileData.department || '';
    document.getElementById('profile-division').value = profileData.division || '';
    document.getElementById('profile-joindate').value = profileData.joindate || '';
    document.getElementById('profile-education').value = profileData.education || '';
    document.getElementById('profile-address').value = profileData.address || '';
    document.getElementById('profile-bank-account').value = profileData.bankAccount || '';
    document.getElementById('profile-bank-name').value = profileData.bankName || '';
    document.getElementById('profile-npwp').value = profileData.npwp || '';
    document.getElementById('profile-bpjs-health').value = profileData.bpjsHealth || '';
    document.getElementById('profile-bpjs-work').value = profileData.bpjsWork || '';
    document.getElementById('profile-emergency-name').value = profileData.emergencyName || '';
    document.getElementById('profile-emergency-relation').value = profileData.emergencyRelation || '';
    document.getElementById('profile-emergency-phone').value = profileData.emergencyPhone || '';
    document.getElementById('profile-notes').value = profileData.notes || '';
    
    // Update display info
    document.getElementById('profile-display-name').textContent = fullname;
    document.getElementById('profile-display-username').textContent = '@' + username;
    document.getElementById('profile-avatar').textContent = fullname.charAt(0).toUpperCase();
    document.getElementById('profile-role').textContent = role;
    document.getElementById('profile-stat-tables').textContent = totalTables;
    document.getElementById('profile-stat-records').textContent = totalRecords;
    document.getElementById('profile-last-login').textContent = new Date().toLocaleString('id-ID', { 
        day: 'numeric', 
        month: 'short', 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    // Show modal
    document.getElementById('profile-modal').classList.add('active');
    document.getElementById('overlay').style.display = 'block';
}

function closeProfile() {
    document.getElementById('profile-modal').classList.remove('active');
    document.getElementById('overlay').style.display = 'none';
}

function saveProfile() {
    const profileData = {
        name: document.getElementById('profile-name').value.trim(),
        nik: document.getElementById('profile-nik').value.trim(),
        birthdate: document.getElementById('profile-birthdate').value.trim(),
        birthplace: document.getElementById('profile-birthplace').value.trim(),
        gender: document.getElementById('profile-gender').value.trim(),
        email: document.getElementById('profile-email').value.trim(),
        phone: document.getElementById('profile-phone').value.trim(),
        religion: document.getElementById('profile-religion').value.trim(),
        marital: document.getElementById('profile-marital').value.trim(),
        nationality: document.getElementById('profile-nationality').value.trim(),
        position: document.getElementById('profile-position').value.trim(),
        department: document.getElementById('profile-department').value.trim(),
        division: document.getElementById('profile-division').value.trim(),
        joindate: document.getElementById('profile-joindate').value.trim(),
        education: document.getElementById('profile-education').value.trim(),
        address: document.getElementById('profile-address').value.trim(),
        bankAccount: document.getElementById('profile-bank-account').value.trim(),
        bankName: document.getElementById('profile-bank-name').value.trim(),
        npwp: document.getElementById('profile-npwp').value.trim(),
        bpjsHealth: document.getElementById('profile-bpjs-health').value.trim(),
        bpjsWork: document.getElementById('profile-bpjs-work').value.trim(),
        emergencyName: document.getElementById('profile-emergency-name').value.trim(),
        emergencyRelation: document.getElementById('profile-emergency-relation').value.trim(),
        emergencyPhone: document.getElementById('profile-emergency-phone').value.trim(),
        notes: document.getElementById('profile-notes').value.trim()
    };
    
    if (!profileData.name) {
        alert('Nama lengkap tidak boleh kosong!');
        return;
    }
    
    localStorage.setItem('userProfile', JSON.stringify(profileData));
    
    // Update user data in systemUsers
    const currentUsername = sessionStorage.getItem('erp_username');
    const users = loadUsers();
    const userIndex = users.findIndex(u => u.username === currentUsername || u.fullname === currentUsername);
    
    if (userIndex !== -1) {
        users[userIndex].fullname = profileData.name;
        saveUsers(users);
    }
    
    // Update session storage
    sessionStorage.setItem('erp_fullname', profileData.name);
    
    // Update sidebar header
    const sidebarHeader = document.getElementById('sidebarHeader');
    if (sidebarHeader) {
        sidebarHeader.innerText = profileData.name;
    }
    
    toast('Profile berhasil disimpan dan sinkron dengan sistem!');
    closeProfile();
}

/* ========== USER MANAGEMENT FUNCTIONS ========== */

// Initialize default users
function initUsers() {
    if (!localStorage.getItem('systemUsers')) {
        const defaultUsers = [
            {
                username: 'admin',
                password: 'admin',
                fullname: 'RIFAKHI RINDHOI SETIAWAN',
                role: 'Admin'
            }
        ];
        localStorage.setItem('systemUsers', JSON.stringify(defaultUsers));
    }
}

// Load users
function loadUsers() {
    initUsers();
    return JSON.parse(localStorage.getItem('systemUsers') || '[]');
}

// Save users
function saveUsers(users) {
    localStorage.setItem('systemUsers', JSON.stringify(users));
}

// Open user management as full page
function openUserManagementPage() {
    activeKey = '__usermgmt__';
    render();
    closeAll();
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Render user management page (Excel-style)
function renderUserManagementPage() {
    // Hide normal table elements
    document.querySelector('.toolbar').style.display = 'none';
    document.getElementById('user-management-container').style.display = 'none';
    
    document.getElementById('disp-title').innerText = 'MANAJEMEN USER';
    
    const users = loadUsers();
    const currentUser = sessionStorage.getItem('erp_username') || 'admin';
    
    // Calculate statistics
    const totalUsers = users.length;
    const adminUsers = users.filter(u => u.role === 'Admin').length;
    const regularUsers = users.filter(u => u.role === 'User').length;
    
    // Pagination calculation
    const totalPages = Math.ceil(totalUsers / userRowsPerPage) || 1;
    const startIndex = (userCurrentPage - 1) * userRowsPerPage;
    const endIndex = startIndex + userRowsPerPage;
    const paginatedUsers = users.slice(startIndex, endIndex);
    
    // Build table HTML - ULTRA COMPACT NO EMOJI
    let tableHTML = `
        <!-- Minimal Stats Info -->
        <div style="background: var(--bg-soft); border-radius: 6px; padding: 8px 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border);">
            <div style="font-size: 11px; color: #666;">
                <strong>Total: ${totalUsers}</strong> | Admin: ${adminUsers} | User: ${regularUsers}
            </div>
            <div style="display: flex; gap: 6px;">
                <button onclick="exportUserData()" style="padding: 4px 10px; border-radius: 3px; border: 1px solid var(--border); background: white; color: var(--text); font-weight: 600; cursor: pointer; font-size: 10px;">EXPORT</button>
                <button onclick="refreshUserList()" style="padding: 4px 10px; border-radius: 3px; border: 1px solid var(--border); background: white; color: var(--text); font-weight: 600; cursor: pointer; font-size: 10px;">REFRESH</button>
            </div>
        </div>
        
        <!-- ULTRA COMPACT TABLE -->
        <table id="mainTable" style="width: 100%; border-collapse: collapse; font-size: 11px; table-layout: auto;">
            <thead id="user-table-head">
                <tr>
                    <th style="padding: 5px 6px; text-align: center; background: var(--bg-soft); border-bottom: 1px solid var(--border); font-weight: 700; font-size: 10px; width: 35px;">NO</th>
                    <th style="padding: 5px 6px; text-align: left; background: var(--bg-soft); border-bottom: 1px solid var(--border); font-weight: 700; font-size: 10px; width: 120px;">USERNAME</th>
                    <th style="padding: 5px 6px; text-align: left; background: var(--bg-soft); border-bottom: 1px solid var(--border); font-weight: 700; font-size: 10px; width: 120px;">PASSWORD</th>
                    <th style="padding: 5px 6px; text-align: left; background: var(--bg-soft); border-bottom: 1px solid var(--border); font-weight: 700; font-size: 10px;">NAMA LENGKAP</th>
                    <th style="padding: 5px 6px; text-align: center; background: var(--bg-soft); border-bottom: 1px solid var(--border); font-weight: 700; font-size: 10px; width: 60px;">ROLE</th>
                    <th style="padding: 5px 6px; text-align: center; background: var(--bg-soft); border-bottom: 1px solid var(--border); font-weight: 700; font-size: 10px; width: 25px;">ST</th>
                    <th style="padding: 5px 6px; text-align: center; background: var(--bg-soft); border-bottom: 1px solid var(--border); font-weight: 700; font-size: 10px; width: 100px;">AKSI</th>
                </tr>
            </thead>
            <tbody id="user-table-body">
    `;
    
    // Existing users - ULTRA COMPACT (paginated)
    paginatedUsers.forEach((user, paginatedIndex) => {
        const actualIndex = startIndex + paginatedIndex;
        const isCurrentUser = user.username === currentUser || user.fullname === currentUser;
        const passId = 'pass-' + actualIndex;
        const toggleId = 'toggle-' + actualIndex;
        
        tableHTML += `
            <tr style="${isCurrentUser ? 'background: #f0f7ff;' : ''} font-size: 11px;">
                <td style="padding: 3px 6px; border-bottom: 1px solid var(--border); text-align: center; font-weight: 600; font-family: monospace; color: #999; font-size: 10px;">${actualIndex + 1}</td>
                <td style="padding: 3px 6px; border-bottom: 1px solid var(--border);">
                    <input type="text" value="${user.username}" readonly style="width: 100%; padding: 3px 5px; border: 1px solid var(--border); border-radius: 2px; background: var(--bg-soft); cursor: not-allowed; font-weight: 500; font-family: monospace; font-size: 10px;">
                </td>
                <td style="padding: 3px 6px; border-bottom: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="password" id="${passId}" value="${user.password}" readonly style="flex: 1; padding: 3px 5px; border: 1px solid var(--border); border-radius: 2px; background: var(--bg-soft); cursor: not-allowed; font-weight: 500; font-family: monospace; font-size: 10px;">
                        <button id="${toggleId}" onclick="togglePassword('${passId}', '${toggleId}')" style="padding: 2px 4px; border: 1px solid var(--border); border-radius: 2px; background: white; cursor: pointer; font-size: 8px; font-weight: 600; width: 38px;">SHOW</button>
                    </div>
                </td>
                <td style="padding: 3px 6px; border-bottom: 1px solid var(--border);">
                    <input type="text" value="${user.fullname}" readonly style="width: 100%; padding: 3px 5px; border: 1px solid var(--border); border-radius: 2px; background: var(--bg-soft); cursor: not-allowed; font-weight: 500; font-size: 10px; white-space: nowrap;">
                </td>
                <td style="padding: 3px 6px; border-bottom: 1px solid var(--border); text-align: center;">
                    <span style="display: inline-block; padding: 2px 6px; border-radius: 8px; font-size: 9px; font-weight: 700; background: ${user.role === 'Admin' ? '#e3f2fd' : '#f5f5f5'}; color: ${user.role === 'Admin' ? '#1976d2' : '#666'};">${user.role}</span>
                </td>
                <td style="padding: 3px 6px; border-bottom: 1px solid var(--border); text-align: center;">
                    ${isCurrentUser ? '<span style="color: #2e7d32; font-weight: 700; font-size: 12px;">â—</span>' : '<span style="color: #9e9e9e; font-size: 10px;">âœ“</span>'}
                </td>
                <td style="padding: 3px 6px; border-bottom: 1px solid var(--border); text-align: center;">
                    ${!isCurrentUser ? `
                        <div style="display: flex; gap: 3px; justify-content: center;">
                            <button onclick="editUserInline(${actualIndex})" style="padding: 3px 7px; border-radius: 2px; border: 1.5px solid #1976d2; background: transparent; color: #1976d2; font-weight: 600; cursor: pointer; font-size: 9px;">EDIT</button>
                            <button onclick="deleteUserInline(${actualIndex})" style="padding: 3px 7px; border-radius: 2px; border: 1.5px solid #d32f2f; background: transparent; color: #d32f2f; font-weight: 600; cursor: pointer; font-size: 9px;">DEL</button>
                        </div>
                    ` : '<span style="color: #999; font-size: 9px;">YOU</span>'}
                </td>
            </tr>
        `;
    });
    
    // Add new user row - ULTRA COMPACT
    tableHTML += `
        <tr style="background: #fafafa; border-top: 2px solid #1976d2; font-size: 11px;">
            <td style="padding: 3px 6px; border-bottom: 1px solid var(--border); text-align: center; font-weight: 700; color: #1976d2; font-size: 12px;">+</td>
            <td style="padding: 3px 6px; border-bottom: 1px solid var(--border);">
                <input type="text" id="new-username" placeholder="Username..." style="width: 100%; padding: 3px 5px; border: 1px solid #1976d2; border-radius: 2px; background: var(--bg-main); color: var(--text); font-weight: 500; font-family: monospace; font-size: 10px;">
            </td>
            <td style="padding: 3px 6px; border-bottom: 1px solid var(--border);">
                <input type="password" id="new-password" placeholder="Pass..." style="width: 100%; padding: 3px 5px; border: 1px solid #1976d2; border-radius: 2px; background: var(--bg-main); color: var(--text); font-weight: 500; font-family: monospace; font-size: 10px;">
            </td>
            <td style="padding: 3px 6px; border-bottom: 1px solid var(--border);">
                <input type="text" id="new-fullname" placeholder="Nama lengkap..." style="width: 100%; padding: 3px 5px; border: 1px solid #1976d2; border-radius: 2px; background: var(--bg-main); color: var(--text); font-weight: 500; font-size: 10px;">
            </td>
            <td style="padding: 3px 6px; border-bottom: 1px solid var(--border);">
                <select id="new-role" style="width: 100%; padding: 3px 5px; border: 1px solid #1976d2; border-radius: 2px; background: var(--bg-main); color: var(--text); font-weight: 500; cursor: pointer; font-size: 10px;">
                    <option value="User">User</option>
                    <option value="Admin">Admin</option>
                </select>
            </td>
            <td style="padding: 3px 6px; border-bottom: 1px solid var(--border); text-align: center;">
                <span style="color: #ff9800; font-weight: 700; font-size: 10px;">â³</span>
            </td>
            <td style="padding: 3px 6px; border-bottom: 1px solid var(--border);">
                <button onclick="addUserInline()" style="width: 100%; padding: 3px 7px; border-radius: 2px; border: 1.5px solid #2e7d32; background: transparent; color: #2e7d32; font-weight: 700; cursor: pointer; font-size: 9px;">ADD</button>
            </td>
        </tr>
    `;
    
    tableHTML += `
            </tbody>
        </table>
    `;
    
    // Get table container and update only the table
    const container = document.querySelector('.table-container');
    const mainTable = container.querySelector('#mainTable');
    const navBox = container.querySelector('.nav-box');
    
    // Update nav-box for user management pagination
    if (navBox) {
        navBox.style.display = 'flex';
        navBox.innerHTML = `
            <div style="display: flex; align-items: center; gap: 5px;">
                <select id="userRowsPerPageSelect" onchange="updateUserRowsPerPage(this.value)" style="border: 1px solid var(--border); border-radius: 3px; font-size: 10px; color: var(--text); background: var(--bg-main); padding: 4px 6px; cursor: pointer; outline: none; min-width: 45px;">
                    <option value="10" ${userRowsPerPage === 10 ? 'selected' : ''}>10</option>
                    <option value="25" ${userRowsPerPage === 25 ? 'selected' : ''}>25</option>
                    <option value="50" ${userRowsPerPage === 50 ? 'selected' : ''}>50</option>
                    <option value="100" ${userRowsPerPage === 100 ? 'selected' : ''}>100</option>
                </select>
                
                <button class="btn-ui" onclick="changeUserPage(1)" style="padding: 4px 8px; font-size: 13px; min-width: 30px;" title="First Page">â®</button>
                <button class="btn-ui" onclick="changeUserPage(userCurrentPage-1)" style="padding: 4px 8px; font-size: 13px; min-width: 30px;" title="Previous">â—€</button>
                
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="font-size: 11px; color: var(--text);">Page</span>
                    <input type="number" id="userPageInput" value="${userCurrentPage}" min="1" max="${totalPages}" onchange="goToUserPage(this.value)" style="width: 40px; padding: 4px; border: 1px solid var(--border); border-radius: 3px; text-align: center; font-size: 11px; font-weight: 700; color: var(--primary);">
                    <span style="font-size: 11px; color: var(--text);">of <span id="userTotalPages">${totalPages}</span></span>
                </div>
                
                <button class="btn-ui" onclick="changeUserPage(userCurrentPage+1)" style="padding: 4px 8px; font-size: 13px; min-width: 30px;" title="Next">â–¶</button>
                <button class="btn-ui" onclick="changeUserPage(${totalPages})" style="padding: 4px 8px; font-size: 13px; min-width: 30px;" title="Last Page">â­</button>
                
                <button class="btn-ui" onclick="renderUserManagementPage()" style="padding: 4px 8px; font-size: 13px; min-width: 30px;" title="Refresh">â†»</button>
            </div>
            
            <div id="userPageInfo" style="font-size: 10px; color: var(--text); font-weight: 600;">Displaying ${startIndex + 1} to ${Math.min(endIndex, totalUsers)} of ${totalUsers} users</div>
        `;
    }
    
    // Replace table content
    mainTable.outerHTML = tableHTML;
    container.style.display = 'block';
}

// Toggle password visibility
function togglePassword(passId, toggleId) {
    const passInput = document.getElementById(passId);
    const toggleBtn = document.getElementById(toggleId);
    
    if (passInput.type === 'password') {
        passInput.type = 'text';
        toggleBtn.textContent = 'HIDE';
    } else {
        passInput.type = 'password';
        toggleBtn.textContent = 'SHOW';
    }
}

// Add user (inline in table)
function addUserInline() {
    const username = document.getElementById('new-username').value.trim();
    const password = document.getElementById('new-password').value.trim();
    const fullname = document.getElementById('new-fullname').value.trim();
    const role = document.getElementById('new-role').value;
    
    if (!username || !password || !fullname) {
        alert('Semua field harus diisi!');
        return;
    }
    
    const users = loadUsers();
    
    // Check duplicate username
    if (users.find(u => u.username === username)) {
        alert('Username sudah digunakan!');
        return;
    }
    
    users.push({ username, password, fullname, role });
    saveUsers(users);
    
    renderUserManagementPage();
    showToast('âœ… User berhasil ditambahkan!');
}

// Edit user
function editUserInline(index) {
    const users = loadUsers();
    const user = users[index];
    
    const newUsername = prompt('Username baru:', user.username);
    if (!newUsername) return;
    
    const newPassword = prompt('Password baru:', user.password);
    if (!newPassword) return;
    
    const newFullname = prompt('Nama lengkap baru:', user.fullname);
    if (!newFullname) return;
    
    // Check duplicate username
    if (users.find((u, i) => u.username === newUsername && i !== index)) {
        alert('Username sudah digunakan!');
        return;
    }
    
    users[index] = {
        username: newUsername,
        password: newPassword,
        fullname: newFullname,
        role: user.role
    };
    
    saveUsers(users);
    renderUserManagementPage();
    showToast('âœ… User berhasil diupdate!');
}

// Delete user
function deleteUserInline(index) {
    if (!confirm('Yakin ingin menghapus user ini?')) return;
    
    const users = loadUsers();
    users.splice(index, 1);
    saveUsers(users);
    
    renderUserManagementPage();
    showToast('âœ… User berhasil dihapus!');
}

// Legacy functions for compatibility
function openUserManagement() { openUserManagementPage(); }
function addUser() { addUserInline(); }
function editUser(index) { editUserInline(index); }
function deleteUser(index) { deleteUserInline(index); }

// Export user data to Excel
function exportUserData() {
    const users = loadUsers();
    const data = [
        ['NO', 'USERNAME', 'NAMA LENGKAP', 'ROLE', 'STATUS']
    ];
    
    users.forEach((user, index) => {
        data.push([
            index + 1,
            user.username,
            user.fullname,
            user.role,
            'Active'
        ]);
    });
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // Auto-size columns
    const wscols = [
        {wch: 5},
        {wch: 20},
        {wch: 30},
        {wch: 15},
        {wch: 15}
    ];
    ws['!cols'] = wscols;
    
    XLSX.utils.book_append_sheet(wb, ws, 'User List');
    XLSX.writeFile(wb, 'ERP_User_List_' + new Date().toISOString().split('T')[0] + '.xlsx');
    
    showToast('âœ… Daftar user berhasil diekspor!');
}

// Refresh user list
function refreshUserList() {
    renderUserManagementPage();
    showToast('âœ… Daftar user berhasil di-refresh!');
}

/* Jalankan render pertama kali */
// Multiple checks to ensure DOM is ready
function initializeApp() {
    console.log('=== INITIALIZING APP ===');
    console.log('Document ready state:', document.readyState);
    
    // Check if all critical elements exist
    const criticalElements = {
        'toolbar': document.querySelector('.toolbar'),
        'tableContainer': document.querySelector('.table-container'),
        'navBox': document.querySelector('.nav-box'),
        'dispTitle': document.getElementById('disp-title'),
        'tableHead': document.getElementById('table-head'),
        'tableBody': document.getElementById('table-body')
    };
    
    let allPresent = true;
    for (const [name, element] of Object.entries(criticalElements)) {
        if (!element) {
            console.error(`Missing element: ${name}`);
            allPresent = false;
        } else {
            console.log(`âœ“ Found element: ${name}`);
        }
    }
    
    if (!allPresent) {
        console.error('Not all elements present, retrying in 100ms...');
        setTimeout(initializeApp, 100);
        return;
    }
    
    console.log('âœ“ All critical DOM elements found!');
    
    // Initialize activeKey with saved value or first available table
    const savedActiveKey = localStorage.getItem('erp_activeKey');
    if (savedActiveKey && config[savedActiveKey]) {
        activeKey = savedActiveKey;
        console.log('Loaded saved activeKey:', activeKey);
    } else {
        // Get first non-archived table
        const firstTable = Object.keys(config).find(k => !config[k].archived);
        if (firstTable) {
            activeKey = firstTable;
            console.log('Using first available table:', activeKey);
        } else {
            console.error('No tables found in config!');
            console.log('Config keys:', Object.keys(config));
        }
    }
    
    // Auto-open category containing active table
    if (config[activeKey]) {
        const activeCategory = config[activeKey].category || "UTAMA";
        if (!openCats.includes(activeCategory)) {
            openCats.push(activeCategory);
            localStorage.setItem('erp_open_cats', JSON.stringify(openCats));
        }
        console.log('Active category:', activeCategory);
    }
    
    console.log('Calling initial render()...');
    try {
        render();
        console.log('âœ“ Initial render complete!');
    } catch (error) {
        console.error('Error during initial render:', error);
    }
}

// Try multiple initialization methods
if (document.readyState === 'loading') {
    console.log('Document still loading, waiting for DOMContentLoaded...');
    document.addEventListener('DOMContentLoaded', initializeApp);
} else {
    console.log('Document already loaded, initializing immediately...');
    // Add small delay to be safe
    setTimeout(initializeApp, 50);
}
</script>
</body>
</html>